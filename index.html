<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Digital Store</title>
    
    <!-- SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        /* CSS: –ú–ò–ù–ò–ú–ê–õ–ò–°–¢–ò–ß–ù–´–ô –ß–ï–†–ù–û-–ë–ï–õ–´–ô –î–ò–ó–ê–ô–ù */
        :root {
            --bg: #ffffff;
            --text: #000000;
            --secondary: #f2f2f2;
            --border: #e5e5e5;
            --accent: #000000;
            --hint: #888888;
            --user-color: #000000; /* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ */
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--user-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        .container {
            padding: 24px 16px 100px 16px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            flex-grow: 1;
        }

        .page { display: none; }
        .page.active { display: block; animation: slideUp 0.3s ease-out; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê */
        h1 { font-size: 34px; font-weight: 800; letter-spacing: -1.5px; margin: 0 0 24px 0; color: var(--text); }
        h2 { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--hint); margin: 32px 0 16px 0; }
        .price { font-size: 22px; font-weight: 800; }

        /* –ö–ê–†–¢–û–ß–ö–ò */
        .card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 12px;
            transition: var(--transition);
        }

        .card:active { transform: scale(0.98); border-color: var(--text); }

        /* –ö–ù–û–ü–ö–ò */
        .btn {
            background: var(--accent);
            color: #ffffff;
            border: none;
            padding: 16px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active { opacity: 0.8; transform: scale(0.96); }
        .btn-outline { background: transparent; color: var(--text); border: 1.5px solid var(--text); }
        .btn-sm { padding: 10px 16px; font-size: 14px; width: auto; }
        .btn-danger { color: #ff3b30; border-color: #ff3b30; }

        /* –§–û–†–ú–´ */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; color: var(--hint); }
        input, select, textarea {
            width: 100%;
            padding: 14px;
            background: var(--secondary);
            border: 1px solid transparent;
            border-radius: 12px;
            font-size: 16px;
            color: var(--text);
            outline: none;
            transition: var(--transition);
        }
        input:focus { border-color: var(--text); background: var(--bg); }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: 12px 0 calc(12px + env(safe-area-inset-bottom));
            border-top: 1px solid var(--border);
            z-index: 1000;
        }

        .nav-item {
            background: none; border: none;
            color: var(--hint);
            font-size: 10px; font-weight: 700;
            text-transform: uppercase;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            flex: 1;
        }

        .nav-item.active { color: var(--text); }
        .nav-icon { font-size: 20px; }

        /* –ò–°–¢–û–†–ò–Ø –ò –ü–†–û–§–ò–õ–¨ */
        .order-row {
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-card {
            background: var(--text);
            color: var(--bg);
            padding: 30px;
            border-radius: 24px;
            text-align: center;
            margin-bottom: 30px;
        }

        /* –õ–û–ê–î–ï–† */
        .loader { color: var(--hint); text-align: center; padding: 40px; }
    </style>
</head>
<body>

    <div class="container">
        
        <!-- –°–¢–†–ê–ù–ò–¶–ê 1: –ú–ê–ì–ê–ó–ò–ù -->
        <div id="page-shop" class="page active">
            <h1>Store</h1>
            <div id="shop-content">
                <div class="loader">Loading products...</div>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê 2: –ü–†–û–§–ò–õ–¨ -->
        <div id="page-profile" class="page">
            <h1>Profile</h1>
            <div class="stat-card">
                <div style="font-size: 12px; opacity: 0.7; text-transform: uppercase; margin-bottom: 8px;">Total Spent</div>
                <div id="total-spent" style="font-size: 36px; font-weight: 800;">0 ‚ÇΩ</div>
            </div>

            <h2>Appearance</h2>
            <div class="card">
                <label>Custom Font Color</label>
                <input type="color" id="color-picker" style="height: 50px; padding: 5px;" onchange="updateThemeColor(this.value)">
            </div>

            <h2>My Orders</h2>
            <div id="order-history"></div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê 3: –ê–î–ú–ò–ù-–í–•–û–î -->
        <div id="page-admin-login" class="page">
            <h1>Admin Access</h1>
            <div class="form-group">
                <label>Security Password</label>
                <input type="password" id="admin-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn" onclick="checkAdminAuth()">Unlock Panel</button>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê 4: –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ -->
        <div id="page-admin-panel" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>Panel</h1>
                <button class="btn btn-sm btn-outline" onclick="adminLogout()">Exit</button>
            </div>

            <div class="card">
                <h2>Lolzteam Market API</h2>
                <div class="form-group">
                    <label>Market API Token</label>
                    <input type="text" id="cfg-lolz-token" placeholder="Paste token here">
                </div>
                <button class="btn btn-sm" onclick="saveAdminSetting('lolzToken', 'cfg-lolz-token')">Save Token</button>
            </div>

            <div class="card">
                <h2>Categories</h2>
                <div class="form-group" style="display: flex; gap: 8px;">
                    <input type="text" id="new-cat-name" placeholder="Category name">
                    <button class="btn btn-sm" onclick="addCategory()">+</button>
                </div>
                <div id="admin-cats-list"></div>
            </div>

            <div class="card">
                <h2>New Product</h2>
                <div class="form-group">
                    <label>Category</label>
                    <select id="prod-cat-id"></select>
                </div>
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="prod-name">
                </div>
                <div class="form-group">
                    <label>Price (RUB)</label>
                    <input type="number" id="prod-price">
                </div>
                <div class="form-group">
                    <label>Lolz Search URL (Optional)</label>
                    <input type="text" id="prod-lolz-url" placeholder="https://lzt.market/telegram/...">
                </div>
                <button class="btn" onclick="addProduct()">Add Product</button>
            </div>

            <h2>Inventory</h2>
            <div id="admin-prods-list"></div>
        </div>

    </div>

    <!-- –¢–ê–ë-–ë–ê–† -->
    <nav class="nav">
        <button class="nav-item active" onclick="switchPage('shop')">
            <span class="nav-icon">üõçÔ∏è</span>
            <span>Shop</span>
        </button>
        <button class="nav-item" onclick="switchPage('profile')">
            <span class="nav-icon">üë§</span>
            <span>Profile</span>
        </button>
        <button class="nav-item" onclick="switchPage('admin')">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>Admin</span>
        </button>
    </nav>

    <script>
        // --- 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyApyvMlfHcFqPt1ROpnqCPXjgkuUjV1hus",
            databaseURL: "https://zikrov09-default-rtdb.firebaseio.com",
            projectId: "zikrov09",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ---
        let state = {
            categories: {},
            products: {},
            settings: { lolzToken: '' }
        };

        let myOrders = JSON.parse(localStorage.getItem('user_orders_v3') || '[]');
        let userColor = localStorage.getItem('user_font_color') || '#000000';

        // --- 3. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        document.addEventListener('DOMContentLoaded', () => {
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            updateThemeColor(userColor);
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Firebase (Real-time)
            db.ref('/').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    state = {
                        categories: data.categories || {},
                        products: data.products || {},
                        settings: data.settings || { lolzToken: '' }
                    };
                    renderShop();
                    if (document.getElementById('page-admin-panel').classList.contains('active')) renderAdmin();
                }
            });
        });

        // --- 4. –†–û–£–¢–ò–ù–ì ---
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            let target = 'page-' + page;
            if (page === 'admin') {
                target = sessionStorage.getItem('is_admin') ? 'page-admin-panel' : 'page-admin-login';
            }

            document.getElementById(target).classList.add('active');
            const navItems = document.querySelectorAll('.nav-item');
            if (page === 'shop') navItems[0].classList.add('active');
            if (page === 'profile') {
                navItems[1].classList.add('active');
                renderProfile();
            }
            if (page === 'admin') navItems[2].classList.add('active');
        }

        // --- 5. –ú–ê–ì–ê–ó–ò–ù –ò –ü–û–ö–£–ü–ö–ê ---
        function renderShop() {
            const container = document.getElementById('shop-content');
            container.innerHTML = '';

            const cats = state.categories;
            const prods = state.products;

            Object.keys(cats).forEach(catId => {
                const catProducts = Object.keys(prods).filter(pId => prods[pId].catId === catId);
                if (catProducts.length === 0) return;

                const catHeader = document.createElement('h2');
                catHeader.innerText = cats[catId].name;
                container.appendChild(catHeader);

                catProducts.forEach(pId => {
                    const p = prods[pId];
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:flex-start">
                            <div>
                                <div style="font-size:18px; font-weight:700; margin-bottom:4px">${p.name}</div>
                                <div style="color:var(--hint); font-size:12px">${p.lolzUrl ? '‚ö° –ê–≤—Ç–æ-–≤—ã–¥–∞—á–∞' : 'üì¶ –†—É—á–Ω–∞—è –≤—ã–¥–∞—á–∞'}</div>
                            </div>
                            <div class="price">${p.price} ‚ÇΩ</div>
                        </div>
                        <button class="btn" id="buy-btn-${pId}" style="margin-top:20px" onclick="purchaseProduct('${pId}')">Buy Now</button>
                        <div id="status-${pId}" style="margin-top:10px; font-size:12px; font-weight:600"></div>
                    `;
                    container.appendChild(card);
                });
            });
        }

        async function purchaseProduct(productId) {
            const p = state.products[productId];
            const btn = document.getElementById(`buy-btn-${productId}`);
            const status = document.getElementById(`status-${productId}`);
            const lolzToken = state.settings.lolzToken;

            btn.disabled = true;
            status.innerText = "Processing...";

            // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –æ–±—ã—á–Ω—ã–π
            if (!p.lolzUrl) {
                setTimeout(() => {
                    completeOrder(p.name, "–û–∂–∏–¥–∞–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", p.price);
                    status.innerText = "Success! Check Profile.";
                    btn.disabled = false;
                }, 1000);
                return;
            }

            // –ï—Å–ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω Lolzteam
            if (!lolzToken) {
                status.innerText = "Error: Admin API not set";
                btn.disabled = false;
                return;
            }

            try {
                const proxy = "https://api.allorigins.win/raw?url=";
                const encodedSearch = encodeURIComponent(`https://api.lzt.market/list?${p.lolzUrl.split('?')[1] || ''}`);
                
                // 1. –ü–æ–∏—Å–∫
                status.innerText = "Searching Lolz Market...";
                const searchRes = await fetch(proxy + encodedSearch, { headers: { 'Authorization': `Bearer ${lolzToken}` } });
                const searchData = await searchRes.json();
                
                if (!searchData.items || searchData.items.length === 0) throw new Error("Out of stock on Market");
                const item = searchData.items[0];

                // 2. –†–µ–∑–µ—Ä–≤
                status.innerText = "Reserving account...";
                const reserveUrl = encodeURIComponent(`https://api.lzt.market/${item.item_id}/reserve`);
                const resRes = await fetch(proxy + reserveUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${lolzToken}` } });
                const resData = await resRes.json();
                if (resData.errors) throw new Error(resData.errors[0]);

                // 3. –ü–æ–∫—É–ø–∫–∞
                status.innerText = "Buying...";
                const buyUrl = encodeURIComponent(`https://api.lzt.market/${item.item_id}/confirm-buy`);
                const buyRes = await fetch(proxy + buyUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${lolzToken}` } });
                const buyData = await buyRes.json();

                // –§–∏–Ω–∞–ª
                const accountInfo = `ID: ${item.item_id} | Data: ${item.login_password || 'Check Market Archive'}`;
                completeOrder(p.name, accountInfo, p.price);
                status.innerText = "Successfully bought!";
                
            } catch (err) {
                status.innerText = "Error: " + err.message;
                btn.disabled = false;
            }
        }

        function completeOrder(name, data, price) {
            const order = { name, data, price: Number(price), date: new Date().toLocaleString() };
            myOrders.push(order);
            localStorage.setItem('user_orders_v3', JSON.stringify(myOrders));
            if (window.Telegram?.WebApp) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        // --- 6. –ü–†–û–§–ò–õ–¨ ---
        function renderProfile() {
            const total = myOrders.reduce((acc, curr) => acc + curr.price, 0);
            document.getElementById('total-spent').innerText = total + ' ‚ÇΩ';
            
            const history = document.getElementById('order-history');
            history.innerHTML = myOrders.length ? '' : '<div class="loader">No orders yet</div>';
            
            [...myOrders].reverse().forEach(o => {
                const div = document.createElement('div');
                div.className = 'order-row';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:700">${o.name}</div>
                        <div style="font-size:11px; color:var(--hint)">${o.date}</div>
                        <code style="font-size:10px; background:var(--secondary); padding:2px 4px; border-radius:4px; display:block; margin-top:5px">${o.data}</code>
                    </div>
                    <div style="font-weight:800">${o.price} ‚ÇΩ</div>
                `;
                history.appendChild(div);
            });
        }

        function updateThemeColor(color) {
            userColor = color;
            document.documentElement.style.setProperty('--user-color', color);
            localStorage.setItem('user_font_color', color);
            document.getElementById('color-picker').value = color;
        }

        // --- 7. –ê–î–ú–ò–ù-–õ–û–ì–ò–ö–ê ---
        function checkAdminAuth() {
            if (document.getElementById('admin-pass').value === 'admin') {
                sessionStorage.setItem('is_admin', 'true');
                switchPage('admin');
            } else alert('Wrong password');
        }

        function adminLogout() {
            sessionStorage.removeItem('is_admin');
            switchPage('shop');
        }

        function addCategory() {
            const name = document.getElementById('new-cat-name').value;
            if (!name) return;
            db.ref('categories').push({ name });
            document.getElementById('new-cat-name').value = '';
        }

        function addProduct() {
            const name = document.getElementById('prod-name').value;
            const price = document.getElementById('prod-price').value;
            const catId = document.getElementById('prod-cat-id').value;
            const lolzUrl = document.getElementById('prod-lolz-url').value;

            if (!name || !price || !catId) return alert('Fill fields');
            db.ref('products').push({ name, price, catId, lolzUrl });
            
            document.getElementById('prod-name').value = '';
            document.getElementById('prod-price').value = '';
        }

        function saveAdminSetting(key, inputId) {
            const val = document.getElementById(inputId).value;
            db.ref('settings/' + key).set(val);
            alert('Saved');
        }

        function renderAdmin() {
            document.getElementById('cfg-lolz-token').value = state.settings.lolzToken || '';
            
            // –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Å–µ–ª–µ–∫—Ç–µ
            const select = document.getElementById('prod-cat-id');
            select.innerHTML = Object.keys(state.categories).map(id => `<option value="${id}">${state.categories[id].name}</option>`).join('');

            // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            const catList = document.getElementById('admin-cats-list');
            catList.innerHTML = Object.keys(state.categories).map(id => `
                <div class="order-row">
                    <span>${state.categories[id].name}</span>
                    <button class="btn btn-sm btn-danger" onclick="db.ref('categories/${id}').remove()">Del</button>
                </div>
            `).join('');

            // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
            const prodList = document.getElementById('admin-prods-list');
            prodList.innerHTML = Object.keys(state.products).map(id => `
                <div class="card">
                    <b>${state.products[id].name}</b> - ${state.products[id].price} ‚ÇΩ
                    <button class="btn btn-sm btn-danger" style="margin-top:10px" onclick="db.ref('products/${id}').remove()">Remove Product</button>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
