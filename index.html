<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Shop Mini App</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        /* Скрываем скроллбар для красоты */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { motion, AnimatePresence } = window.Motion;
        const { ShoppingBag, User, Settings, CreditCard, Coins, Upload, CheckCircle, Plus, Trash2, Palette, Box } = window.lucide;

        // --- Имитация Базы Данных (LocalStorage) ---
        const DB = {
            get: (key, def) => {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : def;
            },
            set: (key, val) => localStorage.setItem(key, JSON.stringify(val))
        };

        const INITIAL_PRODUCTS = [
            { id: 1, title: 'Telegram Premium 3 мес.', price: 1200, category: 'Premium' },
            { id: 2, title: 'Аккаунт USA (+1)', price: 250, category: 'Accounts' },
            { id: 3, title: 'Аккаунт RU (+7)', price: 300, category: 'Accounts' },
            { id: 4, title: 'Канал 2018 года', price: 5000, category: 'Channels' },
        ];

        // --- Главный Компонент ---
        function App() {
            // Состояния
            const [view, setView] = useState('shop');
            const [products, setProducts] = useState(() => DB.get('products', INITIAL_PRODUCTS));
            const [cartItem, setCartItem] = useState(null);
            const [theme, setTheme] = useState(() => DB.get('theme', { bg: '#171717', text: '#ffffff', btn: '#3b82f6', card: '#262626' }));
            const [userStats, setUserStats] = useState(() => DB.get('stats', { spent: 0, orders: [] }));
            const [activeCategory, setActiveCategory] = useState('All');
            
            // Telegram WebApp init
            useEffect(() => {
                if(window.Telegram.WebApp) {
                    window.Telegram.WebApp.ready();
                    window.Telegram.WebApp.expand();
                }
            }, []);

            // Сохранение данных при изменении
            useEffect(() => DB.set('products', products), [products]);
            useEffect(() => DB.set('theme', theme), [theme]);
            useEffect(() => DB.set('stats', userStats), [userStats]);

            // Обработчик покупки (Имитация проверки)
            const handleOrder = (item, method, amountTon) => {
                const newOrder = {
                    id: Date.now(),
                    title: item.title,
                    price: item.price,
                    date: new Date().toLocaleDateString(),
                    status: 'На проверке'
                };
                
                const newStats = {
                    spent: userStats.spent + item.price,
                    orders: [newOrder, ...userStats.orders]
                };
                
                setUserStats(newStats);
                
                // Отправка данных боту (В реальности)
                if(window.Telegram.WebApp.sendData) {
                    // window.Telegram.WebApp.sendData(JSON.stringify(newOrder));
                }
            };

            // Общие стили
            const appStyle = { backgroundColor: theme.bg, color: theme.text, minHeight: '100vh', fontFamily: 'sans-serif' };

            return (
                <div style={appStyle} className="pb-24 transition-colors duration-300">
                    <AnimatePresence mode="wait">
                        {view === 'shop' && (
                            <Shop 
                                key="shop" 
                                products={products} 
                                category={activeCategory} 
                                setCategory={setActiveCategory} 
                                onBuy={(p) => { setCartItem(p); setView('checkout'); }} 
                                theme={theme} 
                            />
                        )}
                        {view === 'checkout' && (
                            <Checkout 
                                key="checkout" 
                                item={cartItem} 
                                theme={theme} 
                                onBack={() => setView('shop')}
                                onSuccess={(method, ton) => handleOrder(cartItem, method, ton)}
                            />
                        )}
                        {view === 'profile' && <Profile key="profile" stats={userStats} theme={theme} />}
                        {view === 'admin' && (
                            <Admin 
                                key="admin" 
                                products={products} 
                                setProducts={setProducts} 
                                theme={theme} 
                                setTheme={setTheme} 
                            />
                        )}
                    </AnimatePresence>

                    {/* Навигация */}
                    <Navigation view={view} setView={setView} theme={theme} />
                </div>
            );
        }

        // --- Компонент Магазина ---
        const Shop = ({ products, category, setCategory, onBuy, theme }) => {
            const categories = ['All', ...new Set(products.map(p => p.category))];
            const filtered = category === 'All' ? products : products.filter(p => p.category === category);

            return (
                <motion.div initial={{opacity:0, x:-20}} animate={{opacity:1, x:0}} exit={{opacity:0, x:20}} className="p-4">
                    <header className="flex justify-between items-center mb-6 mt-2">
                        <h1 className="text-2xl font-extrabold tracking-tight">Каталог</h1>
                        <span className="text-xs px-2 py-1 rounded bg-white/10 opacity-70">v1.0</span>
                    </header>

                    {/* Категории */}
                    <div className="flex gap-2 overflow-x-auto pb-4 mb-2 no-scrollbar">
                        {categories.map(cat => (
                            <button 
                                key={cat}
                                onClick={() => setCategory(cat)}
                                style={{ 
                                    backgroundColor: category === cat ? theme.btn : theme.card,
                                    color: category === cat ? '#fff' : theme.text 
                                }}
                                className="px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap transition-all active:scale-95"
                            >
                                {cat}
                            </button>
                        ))}
                    </div>

                    {/* Сетка товаров */}
                    <div className="grid gap-3">
                        {filtered.map(p => (
                            <div key={p.id} style={{backgroundColor: theme.card}} className="p-4 rounded-2xl flex justify-between items-center shadow-lg border border-white/5">
                                <div>
                                    <h3 className="font-bold text-lg leading-tight">{p.title}</h3>
                                    <p className="opacity-50 text-xs uppercase mt-1 tracking-wider">{p.category}</p>
                                    <div className="mt-2 font-mono text-lg font-bold">{p.price} ₽</div>
                                </div>
                                <button 
                                    onClick={() => onBuy(p)}
                                    style={{backgroundColor: theme.btn}} 
                                    className="h-10 px-5 rounded-xl font-bold text-white shadow-lg active:scale-90 transition-transform flex items-center"
                                >
                                    Купить
                                </button>
                            </div>
                        ))}
                    </div>
                </motion.div>
            );
        };

        // --- Компонент Оплаты ---
        const Checkout = ({ item, theme, onBack, onSuccess }) => {
            const [step, setStep] = useState(1); // 1: Выбор, 2: Оплата, 3: Успех
            const [method, setMethod] = useState(null);
            const [loading, setLoading] = useState(false);
            const tonRate = 550; // Фиксированный курс для примера
            const tonPrice = (item.price / tonRate).toFixed(2);

            const handleUpload = () => {
                setLoading(true);
                // Имитация загрузки
                setTimeout(() => {
                    setLoading(false);
                    onSuccess(method, tonPrice);
                    setStep(3);
                }, 2000);
            };

            if (step === 3) return (
                <div className="flex flex-col items-center justify-center h-[80vh] p-4 text-center">
                    <motion.div initial={{scale:0}} animate={{scale:1}} className="mb-4 text-green-500">
                        <i data-lucide="check-circle" width="64" height="64"></i>
                    </motion.div>
                    <h2 className="text-2xl font-bold mb-2">Заказ отправлен!</h2>
                    <p className="opacity-60 mb-6">Администратор проверит чек и пришлет данные в чат.</p>
                    <button onClick={onBack} style={{backgroundColor: theme.btn}} className="px-6 py-3 rounded-xl text-white font-bold w-full">В магазин</button>
                </div>
            );

            return (
                <motion.div initial={{opacity:0, y:20}} animate={{opacity:1, y:0}} exit={{opacity:0}} className="p-4">
                    <button onClick={onBack} className="mb-4 opacity-50 flex items-center gap-1 text-sm font-bold">← Назад</button>
                    
                    <div style={{backgroundColor: theme.card}} className="p-5 rounded-2xl mb-6 border border-white/5">
                        <p className="opacity-60 text-sm">Покупка:</p>
                        <h2 className="text-xl font-bold mb-4">{item.title}</h2>
                        <div className="h-px bg-white/10 w-full mb-4"></div>
                        <div className="flex justify-between items-end">
                            <div>
                                <p className="text-2xl font-mono font-bold">{item.price} ₽</p>
                                <p className="text-sm opacity-50">~ {tonPrice} TON</p>
                            </div>
                        </div>
                    </div>

                    <h3 className="font-bold mb-3">Выберите метод:</h3>
                    <div className="flex gap-3 mb-6">
                        <button 
                            onClick={() => setMethod('card')} 
                            className={`flex-1 p-4 rounded-xl border-2 transition-all ${method === 'card' ? 'border-blue-500 bg-blue-500/10' : 'border-transparent bg-white/5'}`}
                        >
                            <i data-lucide="credit-card" className="mx-auto mb-2 opacity-80"></i>
                            <div className="text-sm font-bold">Карта</div>
                        </button>
                        <button 
                            onClick={() => setMethod('crypto')} 
                            className={`flex-1 p-4 rounded-xl border-2 transition-all ${method === 'crypto' ? 'border-blue-500 bg-blue-500/10' : 'border-transparent bg-white/5'}`}
                        >
                            <i data-lucide="coins" className="mx-auto mb-2 opacity-80"></i>
                            <div className="text-sm font-bold">TON</div>
                        </button>
                    </div>

                    <AnimatePresence>
                        {method && (
                            <motion.div initial={{opacity:0, height:0}} animate={{opacity:1, height:'auto'}} className="overflow-hidden">
                                <div style={{backgroundColor: theme.card}} className="p-4 rounded-xl text-center">
                                    <p className="text-sm opacity-60 mb-2">Реквизиты для оплаты:</p>
                                    <div className="font-mono bg-black/20 p-3 rounded-lg select-all mb-4 text-sm break-all">
                                        {method === 'card' ? '2200 1234 5678 9000' : 'UQCx...MockTonAddress...x'}
                                    </div>
                                    
                                    <label className="block w-full cursor-pointer active:scale-95 transition-transform">
                                        <div className={`border-2 border-dashed border-white/20 rounded-xl p-8 flex flex-col items-center gap-2 ${loading ? 'opacity-50' : ''}`}>
                                            {loading ? (
                                                <div className="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                                            ) : (
                                                <>
                                                    <i data-lucide="upload" className="opacity-50"></i>
                                                    <span className="text-sm font-bold">Прикрепить чек</span>
                                                    <span className="text-xs opacity-50">(Нажми сюда)</span>
                                                </>
                                            )}
                                        </div>
                                        <input type="file" className="hidden" onChange={handleUpload} disabled={loading} />
                                    </label>
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </motion.div>
            );
        };

        // --- Компонент Админки ---
        const Admin = ({ products, setProducts, theme, setTheme }) => {
            const [newProduct, setNewProduct] = useState({ title: '', price: '', category: 'Accounts' });

            const addProduct = () => {
                if(!newProduct.title || !newProduct.price) return;
                setProducts([...products, { ...newProduct, id: Date.now() }]);
                setNewProduct({ title: '', price: '', category: 'Accounts' });
            };

            const removeProduct = (id) => {
                setProducts(products.filter(p => p.id !== id));
            };

            return (
                <motion.div initial={{opacity:0}} animate={{opacity:1}} className="p-4 pb-24">
                    <h1 className="text-2xl font-bold mb-6">Админ панель</h1>

                    {/* Добавление товара */}
                    <section className="mb-8">
                        <div className="flex items-center gap-2 mb-3">
                            <i data-lucide="box" size="18"></i>
                            <h3 className="font-bold">Добавить товар</h3>
                        </div>
                        <div style={{backgroundColor: theme.card}} className="p-4 rounded-xl space-y-3">
                            <input 
                                type="text" 
                                placeholder="Название" 
                                value={newProduct.title}
                                onChange={e => setNewProduct({...newProduct, title: e.target.value})}
                                className="w-full bg-black/20 p-3 rounded-lg outline-none border border-transparent focus:border-blue-500 transition-colors"
                            />
                            <div className="flex gap-3">
                                <input 
                                    type="number" 
                                    placeholder="Цена (RUB)" 
                                    value={newProduct.price}
                                    onChange={e => setNewProduct({...newProduct, price: Number(e.target.value)})}
                                    className="w-1/2 bg-black/20 p-3 rounded-lg outline-none"
                                />
                                <select 
                                    value={newProduct.category}
                                    onChange={e => setNewProduct({...newProduct, category: e.target.value})}
                                    className="w-1/2 bg-black/20 p-3 rounded-lg outline-none"
                                >
                                    <option value="Accounts">Accounts</option>
                                    <option value="Premium">Premium</option>
                                    <option value="Channels">Channels</option>
                                </select>
                            </div>
                            <button onClick={addProduct} style={{backgroundColor: theme.btn}} className="w-full py-3 rounded-lg font-bold text-white flex justify-center gap-2 items-center">
                                <i data-lucide="plus" size="18"></i> Добавить
                            </button>
                        </div>
                    </section>

                    {/* Список товаров (удаление) */}
                    <section className="mb-8">
                        <h3 className="font-bold mb-3 opacity-70 text-sm uppercase">Активные товары</h3>
                        <div className="space-y-2">
                            {products.map(p => (
                                <div key={p.id} className="flex justify-between items-center bg-white/5 p-3 rounded-lg">
                                    <span className="text-sm font-medium">{p.title}</span>
                                    <button onClick={() => removeProduct(p.id)} className="text-red-400 p-2">
                                        <i data-lucide="trash-2" size="18"></i>
                                    </button>
                                </div>
                            ))}
                        </div>
                    </section>

                    {/* Редактор темы */}
                    <section>
                        <div className="flex items-center gap-2 mb-3">
                            <i data-lucide="palette" size="18"></i>
                            <h3 className="font-bold">Редактор темы</h3>
                        </div>
                        <div style={{backgroundColor: theme.card}} className="p-4 rounded-xl space-y-3">
                            <ThemeInput label="Фон" val={theme.bg} onChange={v => setTheme({...theme, bg: v})} />
                            <ThemeInput label="Карточки" val={theme.card} onChange={v => setTheme({...theme, card: v})} />
                            <ThemeInput label="Кнопки" val={theme.btn} onChange={v => setTheme({...theme, btn: v})} />
                            <ThemeInput label="Текст" val={theme.text} onChange={v => setTheme({...theme, text: v})} />
                        </div>
                    </section>
                </motion.div>
            );
        };

        const ThemeInput = ({ label, val, onChange }) => (
            <div className="flex justify-between items-center">
                <span className="text-sm opacity-80">{label}</span>
                <div className="flex items-center gap-2">
                    <span className="text-xs font-mono opacity-50">{val}</span>
                    <input type="color" value={val} onChange={e => onChange(e.target.value)} className="w-8 h-8 rounded overflow-hidden cursor-pointer border-none p-0" />
                </div>
            </div>
        );

        // --- Профиль ---
        const Profile = ({ stats, theme }) => (
            <motion.div initial={{opacity:0}} animate={{opacity:1}} className="p-4">
                <div className="flex items-center gap-4 mb-8 mt-4">
                    <div className="w-20 h-20 rounded-full bg-gradient-to-tr from-blue-400 to-purple-500 flex items-center justify-center text-3xl font-bold text-white">
                        U
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold">User</h2>
                        <p className="opacity-50">Customer</p>
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-3 mb-8">
                    <div style={{backgroundColor: theme.card}} className="p-5 rounded-2xl text-center border border-white/5">
                        <div className="text-3xl font-bold mb-1">{stats.orders.length}</div>
                        <div className="text-xs uppercase tracking-widest opacity-50">Заказов</div>
                    </div>
                    <div style={{backgroundColor: theme.card}} className="p-5 rounded-2xl text-center border border-white/5">
                        <div className="text-3xl font-bold mb-1">{stats.spent}</div>
                        <div className="text-xs uppercase tracking-widest opacity-50">Рублей</div>
                    </div>
                </div>

                <h3 className="font-bold mb-4 text-lg">История заказов</h3>
                <div className="space-y-3">
                    {stats.orders.length === 0 ? (
                        <div className="text-center opacity-30 py-10">История пуста</div>
                    ) : (
                        stats.orders.map(o => (
                            <div key={o.id} style={{backgroundColor: theme.card}} className="p-4 rounded-xl flex justify-between items-center">
                                <div>
                                    <div className="font-bold">{o.title}</div>
                                    <div className="text-xs opacity-50">{o.date}</div>
                                </div>
                                <div className="text-right">
                                    <div className="font-mono">{o.price} ₽</div>
                                    <div className="text-xs text-yellow-500">{o.status}</div>
                                </div>
                            </div>
                        ))
                    )}
                </div>
            </motion.div>
        );

        // --- Навигация (Меню) ---
        const Navigation = ({ view, setView, theme }) => {
            const items = [
                { id: 'shop', icon: 'shopping-bag', label: 'Магазин' },
                { id: 'profile', icon: 'user', label: 'Профиль' },
                { id: 'admin', icon: 'settings', label: 'Админ' },
            ];

            return (
                <div className="fixed bottom-4 left-4 right-4 h-16 bg-black/80 backdrop-blur-md rounded-2xl flex justify-around items-center border border-white/10 shadow-2xl z-50">
                    {items.map(item => {
                        const isActive = view === item.id;
                        return (
                            <button 
                                key={item.id} 
                                onClick={() => setView(item.id)}
                                className="relative p-2 w-12 h-12 flex items-center justify-center transition-all"
                            >
                                <i 
                                    data-lucide={item.icon} 
                                    style={{ color: isActive ? theme.btn : '#6b7280' }}
                                    className={`transition-all duration-300 ${isActive ? 'scale-110' : 'scale-100'}`}
                                ></i>
                                {isActive && (
                                    <motion.div 
                                        layoutId="dot" 
                                        className="absolute bottom-1 w-1 h-1 rounded-full" 
                                        style={{backgroundColor: theme.btn}}
                                    />
                                )}
                            </button>
                        )
                    })}
                </div>
            );
        };

        // Рендер приложения и иконок
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Инициализация иконок Lucide после рендера React
        setTimeout(() => {
            window.lucide.createIcons();
        }, 100);

        // Хак для обновления иконок при смене страниц (так как мы используем lucide через CDN)
        const observer = new MutationObserver(() => window.lucide.createIcons());
        observer.observe(document.body, { childList: true, subtree: true });

    </script>
</body>
</html>
