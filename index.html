<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Digital Premium Store</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ (Firebase –∏ Telegram WebApp) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò: –ú–ò–ù–ò–ú–ê–õ–ò–ó–ú */
        :root {
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --text-color: #1c1c1e;
            --accent-color: #007aff;
            --hint-color: #8e8e93;
            --border-color: #d1d1d6;
            --success-color: #34c759;
            --danger-color: #ff3b30;
            --radius: 20px;
            --shadow: 0 4px 16px rgba(0,0,0,0.06);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            padding: 20px 16px 120px 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* –°–¢–†–ê–ù–ò–¶–´ */
        .page {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –ö–ê–†–¢–û–ß–ö–ò –¢–û–í–ê–†–û–í –ò –ó–ê–ö–ê–ó–û–í */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.02);
        }

        h1 { font-size: 28px; font-weight: 800; margin: 0 0 20px 0; letter-spacing: -0.5px; }
        h2 { font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--hint-color); margin: 24px 0 12px 0; letter-spacing: 0.5px; }

        /* –ö–ù–û–ü–ö–ò */
        .btn {
            background: var(--accent-color);
            color: #ffffff;
            border: none;
            padding: 16px 20px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .btn-secondary {
            background: #e5e5ea;
            color: #000000;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 13px;
            width: auto;
            border-radius: 10px;
        }

        .btn-danger {
            background: #fff1f0;
            color: var(--danger-color);
            border: 1px solid #ffccc7;
        }

        /* –ü–û–õ–Ø –í–í–û–î–ê */
        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            margin-left: 4px;
            color: var(--hint-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: #ffffff;
            font-size: 16px;
            color: var(--text-color);
            transition: border 0.2s ease;
        }

        input:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
            border-top: 1px solid var(--border-color);
            z-index: 1000;
        }

        .nav-item {
            background: none;
            border: none;
            color: var(--hint-color);
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .nav-item.active {
            color: var(--accent-color);
        }

        .nav-icon {
            font-size: 22px;
        }

        /* –°–¢–ê–¢–£–°–´ */
        .badge {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-review { background: #fff4e5; color: #ff9500; }
        .status-done { background: #eefdf3; color: #34c759; }
        .status-reject { background: #fff1f0; color: #ff3b30; }

        .price {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-color);
        }

        /* –õ–û–ê–î–ï–† –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï */
        #overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            font-weight: 600;
        }

        .hidden { display: none !important; }

        /* –°–ü–ò–°–û–ö –ê–î–ú–ò–ù–ê */
        .admin-order-card {
            border-left: 4px solid var(--accent-color);
        }

        .img-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 12px;
            margin: 10px 0;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>

    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="overlay">
        <div style="margin-bottom: 10px;">‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
        <small id="overlay-text">–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç</small>
    </div>

    <div class="container">
        
        <!-- –°–¢–†–ê–ù–ò–¶–ê: –ú–ê–ì–ê–ó–ò–ù -->
        <div id="page-shop" class="page active">
            <h1>–ú–∞–≥–∞–∑–∏–Ω</h1>
            <div id="shop-content">
                <div style="text-align:center; padding:40px; color:var(--hint-color);">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê: –û–ü–õ–ê–¢–ê –ó–ê–ö–ê–ó–ê -->
        <div id="page-checkout" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
                <button class="btn btn-secondary btn-sm" onclick="switchPage('shop')">‚Üê –ù–∞–∑–∞–¥</button>
                <h1 style="margin:0">–û–ø–ª–∞—Ç–∞</h1>
            </div>

            <div class="card">
                <p style="margin-top:0;">–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º –Ω–∏–∂–µ:</p>
                <div id="checkout-reks" style="background:var(--bg-color); padding:16px; border-radius:12px; font-weight:700; white-space:pre-wrap; margin-bottom:12px;"></div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:var(--hint-color); font-weight:600;">–ö –æ–ø–ª–∞—Ç–µ:</span>
                    <span class="price" id="checkout-price">0 ‚ÇΩ</span>
                </div>
            </div>

            <div class="card">
                <label>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞</label>
                <input type="file" id="pay-screenshot-file" accept="image/*" style="padding: 10px; border: 1px dashed var(--border-color);">
                <p style="font-size:12px; color:var(--hint-color); margin-top:10px;">–ú—ã –ø—Ä–æ–≤–µ—Ä–∏–º –æ–ø–ª–∞—Ç—É –∏ –≤—ã–¥–∞–¥–∏–º —Ç–æ–≤–∞—Ä –≤ —Ç–µ—á–µ–Ω–∏–µ 15-30 –º–∏–Ω—É—Ç.</p>
                <button class="btn" style="margin-top:20px;" onclick="handleOrderSubmit()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</button>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê: –ò–°–¢–û–†–ò–Ø –ó–ê–ö–ê–ó–û–í -->
        <div id="page-orders" class="page">
            <h1>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h1>
            <div id="orders-content"></div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê: –í–•–û–î –í –ê–î–ú–ò–ù–ö–£ -->
        <div id="page-admin-login" class="page">
            <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <div class="card">
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞</label>
                    <input type="password" id="admin-password-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn" onclick="adminAuth()">–í–æ–π—Ç–∏</button>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê: –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
        <div id="page-admin-panel" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1 style="margin:0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h1>
                <button class="btn btn-secondary btn-sm" onclick="adminLogout()">–í—ã—Ö–æ–¥</button>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="card">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
                <div class="form-group">
                    <label>–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã</label>
                    <textarea id="set-reks" rows="3" placeholder="–ö–∞—Ä—Ç–∞ –°–ë–ü / –ö—Ä–∏–ø—Ç–æ–∫–æ—à–µ–ª–µ–∫"></textarea>
                </div>
                <div class="form-group">
                    <label>ImgBB API Key</label>
                    <input type="text" id="set-imgbb" placeholder="–ö–ª—é—á —Å api.imgbb.com">
                </div>
                <div class="form-group">
                    <label>Telegram Bot Token</label>
                    <input type="text" id="set-bot-token" placeholder="–¢–æ–∫–µ–Ω –æ—Ç @BotFather">
                </div>
                <div class="form-group">
                    <label>–í–∞—à Telegram ID</label>
                    <input type="text" id="set-admin-id" placeholder="–í–∞—à ID (–¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)">
                </div>
                <div class="form-group">
                    <label>Lolz Market Token</label>
                    <input type="text" id="set-lolz-token" placeholder="–¢–æ–∫–µ–Ω —Å lzt.market">
                </div>
                <button class="btn btn-sm" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>

            <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
            <div class="card">
                <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="new-p-name">
                </div>
                <div class="form-group">
                    <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
                    <input type="number" id="new-p-price">
                </div>
                <div class="form-group">
                    <label>–¢–∏–ø —Ç–æ–≤–∞—Ä–∞</label>
                    <select id="new-p-type" onchange="toggleAdminProductFields()">
                        <option value="text">–¢–µ–∫—Å—Ç (–ö–ª—é—á / –ê–∫–∫–∞—É–Ω—Ç)</option>
                        <option value="file">–§–∞–π–ª (–°—Å—ã–ª–∫–∞)</option>
                        <option value="lolz">Lolz Market (–ê–≤—Ç–æ–≤—ã–∫—É–ø)</option>
                    </select>
                </div>
                <div id="admin-field-manual">
                    <label>–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–¥–∞—á–∏</label>
                    <textarea id="new-p-data" rows="2" placeholder="–õ–æ–≥–∏–Ω:–ü–∞—Ä–æ–ª—å –∏–ª–∏ —Å—Å—ã–ª–∫–∞"></textarea>
                </div>
                <div id="admin-field-lolz" class="hidden">
                    <label>–°—Å—ã–ª–∫–∞ –ø–æ–∏—Å–∫–∞ Lolz Market</label>
                    <input type="text" id="new-p-lolz" placeholder="https://lzt.market/telegram/...">
                </div>
                <button class="btn" style="margin-top:10px" onclick="addNewProduct()">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
            </div>

            <h2>–ó–∞–∫–∞–∑—ã –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</h2>
            <div id="admin-orders-review"></div>

            <h2>–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤</h2>
            <div id="admin-all-products"></div>
        </div>

    </div>

    <!-- –ú–ï–ù–Æ -->
    <nav class="nav">
        <button class="nav-item active" onclick="switchPage('shop')">
            <span class="nav-icon">üõçÔ∏è</span>
            <span>–ú–∞–≥–∞–∑–∏–Ω</span>
        </button>
        <button class="nav-item" onclick="switchPage('orders')">
            <span class="nav-icon">üì¶</span>
            <span>–ó–∞–∫–∞–∑—ã</span>
        </button>
        <button class="nav-item" id="nav-admin-link" onclick="switchPage('admin')">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>–ê–¥–º–∏–Ω</span>
        </button>
    </nav>

    <script>
        // --- 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ---
        // –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û –ù–ê –í–ê–®–ò –î–ê–ù–ù–´–ï –ò–ó FIREBASE CONSOLE
        const firebaseConfig = {
            apiKey: "AIzaSyApyvMlfHcFqPt1ROpnqCPXjgkuUjV1hus",
            databaseURL: "https://zikrov09-default-rtdb.firebaseio.com",
            projectId: "zikrov09",
        };
        
        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();

        // --- 2. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        const tg = window.Telegram.WebApp;
        let appState = { products: {}, settings: {}, orders: {} };
        let selectedProductId = null;

        // --- 3. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        document.addEventListener('DOMContentLoaded', () => {
            tg.ready();
            tg.expand();

            // –°–ª—É—à–∞—Ç–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase
            rdb.ref('/').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                appState = {
                    products: data.products || {},
                    settings: data.settings || {},
                    orders: data.orders || {}
                };
                renderShop();
                renderUserOrders();
                if (sessionStorage.getItem('isAdmin')) renderAdminPanel();
            });
        });

        // --- 4. –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            let targetPage = 'page-' + pageId;
            
            // –ó–∞—â–∏—Ç–∞ –∞–¥–º–∏–Ω–∫–∏
            if (pageId === 'admin') {
                targetPage = sessionStorage.getItem('isAdmin') ? 'page-admin-panel' : 'page-admin-login';
            }

            document.getElementById(targetPage).classList.add('active');
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –º–µ–Ω—é
            const menuIdx = { 'shop': 0, 'orders': 1, 'admin': 2 }[pageId];
            document.querySelectorAll('.nav-item')[menuIdx].classList.add('active');
        }

        // --- 5. –§–£–ù–ö–¶–ò–ò –ú–ê–ì–ê–ó–ò–ù–ê ---
        function renderShop() {
            const container = document.getElementById('shop-content');
            container.innerHTML = '';
            
            const products = appState.products;
            if (Object.keys(products).length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--hint-color);">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ó–∞–≥–ª—è–Ω–∏—Ç–µ –ø–æ–∑–∂–µ!</div>';
                return;
            }

            Object.keys(products).forEach(id => {
                const p = products[id];
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div style="font-size:18px; font-weight:800; margin-bottom:4px;">${p.name}</div>
                    <div style="color:var(--hint-color); font-size:13px; margin-bottom:16px;">–¶–∏—Ñ—Ä–æ–≤–æ–π —Ç–æ–≤–∞—Ä ‚Ä¢ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –≤—ã–¥–∞—á–∞</div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="price">${p.price} ‚ÇΩ</span>
                        <button class="btn btn-sm" onclick="openCheckout('${id}')">–ö—É–ø–∏—Ç—å</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openCheckout(productId) {
            selectedProductId = productId;
            const p = appState.products[productId];
            document.getElementById('checkout-reks').innerText = appState.settings.reks || '–†–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∞–¥–º–∏–Ω–æ–º.';
            document.getElementById('checkout-price').innerText = p.price + ' ‚ÇΩ';
            switchPage('shop'); // –ß—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            document.getElementById('page-shop').classList.remove('active');
            document.getElementById('page-checkout').classList.add('active');
        }

        // --- 6. –ó–ê–ì–†–£–ó–ö–ê –°–ö–†–ò–ù–®–û–¢–ê –ò –°–û–ó–î–ê–ù–ò–ï –ó–ê–ö–ê–ó–ê ---
        async function handleOrderSubmit() {
            const fileInput = document.getElementById('pay-screenshot-file');
            const file = fileInput.files[0];
            const imgbbKey = appState.settings.imgbb;

            if (!file) return alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–ø–ª–∞—Ç—ã.');
            if (!imgbbKey) return alert('–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ImgBB –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω.');

            showOverlay(true, '–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç...');

            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ ImgBB
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (!result.success) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');

                const imageUrl = result.data.url;
                const product = appState.products[selectedProductId];
                const orderId = 'ORD-' + Date.now();
                const user = tg.initDataUnsafe.user || { id: 0, first_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' };

                const orderData = {
                    id: orderId,
                    userId: user.id,
                    userName: user.first_name + (user.username ? ` (@${user.username})` : ''),
                    productName: product.name,
                    productId: selectedProductId,
                    price: product.price,
                    screenshot: imageUrl,
                    status: 'review',
                    timestamp: new Date().toLocaleString('ru-RU')
                };

                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase
                await rdb.ref('orders/' + orderId).set(orderData);

                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç
                await sendBotNotification(orderData);

                alert('–í–∞—à –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É! –°—Ç–∞—Ç—É—Å –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ó–∞–∫–∞–∑—ã".');
                fileInput.value = '';
                switchPage('orders');
            } catch (err) {
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + err.message);
            } finally {
                showOverlay(false);
            }
        }

        async function sendBotNotification(order) {
            const token = appState.settings.botToken;
            const chatId = appState.settings.adminId;
            if (!token || !chatId) return;

            const text = `üõç <b>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #${order.id}</b>\n\n` +
                         `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${order.userName}\n` +
                         `üì¶ –¢–æ–≤–∞—Ä: ${order.productName}\n` +
                         `üí∞ –°—É–º–º–∞: ${order.price} ‚ÇΩ\n\n` +
                         `üñº <a href="${order.screenshot}">–û—Ç–∫—Ä—ã—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–ø–ª–∞—Ç—ã</a>`;

            try {
                await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: text,
                        parse_mode: 'HTML'
                    })
                });
            } catch (e) { console.error('Bot Notify Error', e); }
        }

        // --- 7. –ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
        function renderUserOrders() {
            const container = document.getElementById('orders-content');
            const myId = tg.initDataUnsafe.user?.id || 0;
            const orders = appState.orders;
            
            const myOrders = Object.values(orders)
                .filter(o => o.userId == myId)
                .sort((a, b) => b.id.localeCompare(a.id));

            if (myOrders.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--hint-color);">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>';
                return;
            }

            container.innerHTML = myOrders.map(o => {
                const statusLabels = { 'review': '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', 'done': '–í—ã–ø–æ–ª–Ω–µ–Ω', 'reject': '–û—Ç–∫–ª–æ–Ω–µ–Ω' };
                return `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                            <div>
                                <div style="font-weight:700;">${o.productName}</div>
                                <div style="font-size:12px; color:var(--hint-color);">${o.timestamp}</div>
                            </div>
                            <span class="badge status-${o.status}">${statusLabels[o.status]}</span>
                        </div>
                        <div style="font-size:14px; font-weight:700; color:var(--accent-color); margin-bottom:10px;">${o.price} ‚ÇΩ</div>
                        ${o.status === 'done' ? `
                            <div style="background:var(--bg-color); padding:12px; border-radius:10px; font-family:monospace; font-size:13px; border:1px dashed var(--success-color); word-break:break-all;">
                                <b>–î–∞–Ω–Ω—ã–µ:</b><br>${o.data}
                            </div>
                        ` : ''}
                        ${o.status === 'reject' ? `<div style="color:var(--danger-color); font-size:12px;">–ó–∞–∫–∞–∑ –æ—Ç–∫–ª–æ–Ω–µ–Ω. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // --- 8. –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ ---
        function adminAuth() {
            const pass = document.getElementById('admin-password-input').value;
            if (pass === '1233') { // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–π –ø–∞—Ä–æ–ª—å
                sessionStorage.setItem('isAdmin', 'true');
                switchPage('admin');
                renderAdminPanel();
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
            }
        }

        function adminLogout() {
            sessionStorage.removeItem('isAdmin');
            switchPage('shop');
        }

        function toggleAdminProductFields() {
            const type = document.getElementById('new-p-type').value;
            document.getElementById('admin-field-manual').classList.toggle('hidden', type === 'lolz');
            document.getElementById('admin-field-lolz').classList.toggle('hidden', type !== 'lolz');
        }

        function renderAdminPanel() {
            const s = appState.settings;
            document.getElementById('set-reks').value = s.reks || '';
            document.getElementById('set-imgbb').value = s.imgbb || '';
            document.getElementById('set-bot-token').value = s.botToken || '';
            document.getElementById('set-admin-id').value = s.adminId || '';
            document.getElementById('set-lolz-token').value = s.lolzToken || '';

            // –°–ø–∏—Å–æ–∫ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
            const reviewCont = document.getElementById('admin-orders-review');
            const toReview = Object.values(appState.orders).filter(o => o.status === 'review');
            
            reviewCont.innerHTML = toReview.map(o => `
                <div class="card admin-order-card">
                    <b>${o.productName}</b> - ${o.price} ‚ÇΩ<br>
                    <small>${o.userName} (${o.timestamp})</small><br>
                    <img src="${o.screenshot}" class="img-preview" onclick="window.open('${o.screenshot}')">
                    <div style="display:flex; gap:8px; margin-top:10px;">
                        <button class="btn btn-sm" onclick="approveOrder('${o.id}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                        <button class="btn btn-sm btn-danger" onclick="updateOrderStatus('${o.id}', 'reject')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            `).join('') || '<p style="font-size:13px; color:var(--hint-color);">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</p>';

            // –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
            const prodListCont = document.getElementById('admin-all-products');
            prodListCont.innerHTML = Object.keys(appState.products).map(id => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--border-color);">
                    <span style="font-size:14px;">${appState.products[id].name} (${appState.products[id].price} ‚ÇΩ)</span>
                    <button class="btn btn-sm btn-danger" onclick="deleteProduct('${id}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        }

        async function approveOrder(orderId) {
            const order = appState.orders[orderId];
            const product = appState.products[order.productId];
            showOverlay(true, '–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–¥–∞—á–∏...');

            let issuedData = "";
            
            try {
                if (product.type === 'lolz') {
                    issuedData = await handleLolzPurchase(product.lolzUrl);
                } else {
                    issuedData = product.data;
                }

                await rdb.ref(`orders/${orderId}`).update({
                    status: 'done',
                    data: issuedData
                });
                alert('–ó–∞–∫–∞–∑ –æ–¥–æ–±—Ä–µ–Ω –∏ —Ç–æ–≤–∞—Ä –≤—ã–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!');
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ: ' + err.message);
            } finally {
                showOverlay(false);
            }
        }

        async function handleLolzPurchase(searchUrl) {
            const token = appState.settings.lolzToken;
            if (!token) throw new Error('Lolz Token –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!');

            const proxy = "https://api.allorigins.win/raw?url=";
            const searchApi = encodeURIComponent(`https://api.lzt.market/list?${searchUrl.split('?')[1] || ''}`);
            
            const response = await fetch(proxy + searchApi, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await response.json();
            
            if (!data.items || data.items.length === 0) throw new Error('–ù–∞ Lolz Market –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É.');
            
            const item = data.items[0];
            // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å POST –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ä–µ–∑–µ—Ä–≤ –∏ –ø–æ–∫—É–ø–∫—É, 
            // –Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –º—ã –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
            return `ID —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ç–µ: ${item.item_id}\n–ó–∞–≥–æ–ª–æ–≤–æ–∫: ${item.item_title}\n–î–∞–Ω–Ω—ã–µ: ${item.login_password || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞—Ä—Ö–∏–≤ –ø–æ–∫—É–ø–æ–∫ –Ω–∞ –ú–∞—Ä–∫–µ—Ç–µ'}`;
        }

        function updateOrderStatus(id, status) {
            rdb.ref(`orders/${id}/status`).set(status);
        }

        function deleteProduct(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) rdb.ref(`products/${id}`).remove();
        }

        function saveSettings() {
            const settings = {
                reks: document.getElementById('set-reks').value,
                imgbb: document.getElementById('set-imgbb').value,
                botToken: document.getElementById('set-bot-token').value,
                adminId: document.getElementById('set-admin-id').value,
                lolzToken: document.getElementById('set-lolz-token').value
            };
            rdb.ref('settings').set(settings).then(() => alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!'));
        }

        function addNewProduct() {
            const name = document.getElementById('new-p-name').value;
            const price = document.getElementById('new-p-price').value;
            const type = document.getElementById('new-p-type').value;
            const data = document.getElementById('new-p-data').value;
            const lolzUrl = document.getElementById('new-p-lolz').value;

            if(!name || !price) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É!');

            const newProduct = { name, price, type, data, lolzUrl };
            rdb.ref('products').push(newProduct).then(() => {
                alert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!');
                document.getElementById('new-p-name').value = '';
                document.getElementById('new-p-price').value = '';
                document.getElementById('new-p-data').value = '';
                document.getElementById('new-p-lolz').value = '';
            });
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function showOverlay(show, text = '') {
            document.getElementById('overlay').style.display = show ? 'flex' : 'none';
            document.getElementById('overlay-text').innerText = text;
        }
    </script>
</body>
</html>
