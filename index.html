<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Shop Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); margin: 0; padding: 15px; }
        .category-btn { display: block; width: 100%; padding: 10px; margin-bottom: 5px; background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; border-radius: 8px; cursor: pointer; }
        .product-card { border: 1px solid #ccc; padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .hidden { display: none; }
        input, textarea { width: 100%; margin-top: 10px; padding: 8px; box-sizing: border-box; }
        .admin-panel { border-top: 2px solid #666; margin-top: 20px; padding-top: 10px; }
        .history-item { font-size: 0.8em; border-bottom: 1px solid #eee; padding: 5px 0; }
    </style>
</head>
<body>

    <div id="main-page">
        <h2>üõç –ú–∞–≥–∞–∑–∏–Ω</h2>
        <div id="categories-list">
            </div>
        <button onclick="showHistory()" class="category-btn" style="background: gray;">üìú –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</button>
    </div>

    <div id="products-page" class="hidden">
        <button onclick="showMain()">‚¨Ö –ù–∞–∑–∞–¥</button>
        <h2 id="cat-title">–¢–æ–≤–∞—Ä—ã</h2>
        <div id="products-list"></div>
    </div>

    <div id="payment-page" class="hidden">
        <button onclick="showMain()">‚¨Ö –û—Ç–º–µ–Ω–∞</button>
        <h2>–û–ø–ª–∞—Ç–∞ –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º</h2>
        <p>–°—É–º–º–∞: <b id="pay-price"></b> —Ä—É–±.</p>
        <p>–†–µ–∫–≤–∏–∑–∏—Ç—ã: <b>4444 0000 1111 2222</b></p>
        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–û–ø–ª–∞—Ç–∏—Ç—å":</p>
        <input type="file" id="screenshot" accept="image/*">
        <button class="category-btn" onclick="sendOrder()" style="margin-top:20px;">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
    </div>

    <div id="history-page" class="hidden">
        <button onclick="showMain()">‚¨Ö –ù–∞–∑–∞–¥</button>
        <h2>–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è</h2>
        <div id="history-list"></div>
    </div>

    <hr>
    <div id="admin-section" class="admin-panel hidden">
        <h3>‚öô –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
        <input type="text" id="new-cat" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
        <button onclick="addCategory()">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
        <br><br>
        <input type="text" id="prod-name" placeholder="–ò–º—è —Ç–æ–≤–∞—Ä–∞">
        <input type="number" id="prod-price" placeholder="–¶–µ–Ω–∞">
        <select id="prod-cat-select"></select>
        <button onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // –ò–º–∏—Ç–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ LocalStorage (—á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø—Ä–æ–ø–∞–¥–∞–ª–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ)
        let data = JSON.parse(localStorage.getItem('shopData')) || {
            categories: [{id: 1, name: "–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞"}],
            products: [{id: 1, catId: 1, name: "–ù–∞—É—à–Ω–∏–∫–∏", price: 1500}],
            orders: []
        };

        const adminId = 12345678; // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® ID

        function save() { localStorage.setItem('shopData', JSON.stringify(data)); render(); }

        function render() {
            // –†–µ–Ω–¥–µ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            const catDiv = document.getElementById('categories-list');
            const select = document.getElementById('prod-cat-select');
            catDiv.innerHTML = ''; select.innerHTML = '';
            data.categories.forEach(c => {
                catDiv.innerHTML += `<button class="category-btn" onclick="showProducts(${c.id}, '${c.name}')">${c.name}</button>`;
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });

            // –ü–æ–∫–∞–∑ –∞–¥–º–∏–Ω–∫–∏ –µ—Å–ª–∏ —é–∑–µ—Ä - –∞–¥–º–∏–Ω
            if (tg.initDataUnsafe?.user?.id === adminId) {
                document.getElementById('admin-section').classList.remove('hidden');
            }
        }

        function showProducts(catId, name) {
            document.getElementById('main-page').classList.add('hidden');
            document.getElementById('products-page').classList.remove('hidden');
            document.getElementById('cat-title').innerText = name;
            const list = document.getElementById('products-list');
            list.innerHTML = '';
            data.products.filter(p => p.catId === catId).forEach(p => {
                list.innerHTML += `
                    <div class="product-card">
                        <b>${p.name}</b> ‚Äî ${p.price} —Ä—É–±.
                        <button onclick="startPay('${p.name}', ${p.price})">–ö—É–ø–∏—Ç—å</button>
                    </div>`;
            });
        }

        function startPay(name, price) {
            document.getElementById('products-page').classList.add('hidden');
            document.getElementById('payment-page').classList.remove('hidden');
            document.getElementById('pay-price').innerText = price;
            window.currentOrder = { name, price };
        }

        function sendOrder() {
            const file = document.getElementById('screenshot').files[0];
            if (!file) return alert("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç!");

            const orderInfo = `–ó–∞–∫–∞–∑: ${window.currentOrder.name} (${window.currentOrder.price} —Ä—É–±.)`;
            data.orders.push({ text: orderInfo, status: "–ü—Ä–æ–≤–µ—Ä–∫–∞" });
            save();

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É
            tg.sendData(JSON.stringify({
                action: "new_order",
                item: window.currentOrder.name,
                price: window.currentOrder.price,
                user: tg.initDataUnsafe?.user?.username || "unknown"
            }));
            
            tg.close();
        }

        function showHistory() {
            document.getElementById('main-page').classList.add('hidden');
            document.getElementById('history-page').classList.remove('hidden');
            const list = document.getElementById('history-list');
            list.innerHTML = data.orders.length ? data.orders.map(o => `<div class="history-item">${o.text} - <b>${o.status}</b></div>`).join('') : "–ü—É—Å—Ç–æ";
        }

        function showMain() {
            document.querySelectorAll('div[id$="-page"]').forEach(d => d.classList.add('hidden'));
            document.getElementById('main-page').classList.remove('hidden');
        }

        // –ê–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏–∏
        function addCategory() {
            const name = document.getElementById('new-cat').value;
            data.categories.push({id: Date.now(), name});
            save();
        }

        function addProduct() {
            const name = document.getElementById('prod-name').value;
            const price = document.getElementById('prod-price').value;
            const catId = parseInt(document.getElementById('prod-cat-select').value);
            data.products.push({id: Date.now(), catId, name, price});
            save();
        }

        render();
    </script>
</body>
</html>
