<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Digital Store Ultra Edition v6.0</title>

    <!-- –í–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        /* 
        ========================================================================
        1. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –¢–ï–ú–ê
        ========================================================================
        */
        :root {
            --bg-body: #f2f2f7;
            --bg-card: #ffffff;
            --text-main: #1c1c1e;
            --text-hint: #8e8e93;
            --accent: #007aff;
            --accent-soft: rgba(0, 122, 255, 0.1);
            --border: #d1d1d6;
            --success: #34c759;
            --warning: #ff9500;
            --error: #ff3b30;
            --radius-xl: 30px;
            --radius-lg: 20px;
            --radius-md: 14px;
            --radius-sm: 8px;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
            --safe-bottom: env(safe-area-inset-bottom);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ Telegram */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #000000;
                --bg-card: #1c1c1e;
                --text-main: #ffffff;
                --text-hint: #98989d;
                --border: #38383a;
                --shadow: 0 10px 40px rgba(0,0,0,0.4);
            }
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* 
        ========================================================================
        2. –û–°–ù–û–í–ù–´–ï –ö–û–ù–¢–ï–ô–ù–ï–†–´
        ========================================================================
        */
        .app-container {
            max-width: 650px;
            margin: 0 auto;
            min-height: 100vh;
            padding: 20px 16px 140px;
            position: relative;
        }

        .page {
            display: none;
            width: 100%;
            animation: fadeIn 0.4s ease-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 
        ========================================================================
        3. –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê
        ========================================================================
        */
        h1 { font-size: 34px; font-weight: 800; margin: 0 0 8px; letter-spacing: -1px; }
        h2 { font-size: 22px; font-weight: 700; margin: 30px 0 15px; }
        .sub-header { font-size: 16px; color: var(--text-hint); margin-bottom: 25px; }
        .section-label { font-size: 12px; font-weight: 800; text-transform: uppercase; color: var(--text-hint); letter-spacing: 1px; margin: 25px 4px 10px; display: block; }

        /* 
        ========================================================================
        4. –ö–ê–†–¢–û–ß–ö–ò –ò –ö–ù–û–ü–ö–ò
        ========================================================================
        */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .card:active { transform: scale(0.98); }

        .btn {
            background: var(--accent);
            color: #ffffff;
            border: none;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 700;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn:active { opacity: 0.8; transform: scale(0.97); }
        .btn-secondary { background: var(--border); color: var(--text-main); }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text-main); }
        .btn-danger { color: var(--error); border-color: var(--error); background: transparent; }
        .btn-sm { padding: 8px 16px; font-size: 13px; border-radius: 10px; width: auto; }

        /* 
        ========================================================================
        5. –§–û–†–ú–´
        ========================================================================
        */
        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border-radius: var(--radius-md);
            border: 1.5px solid var(--border);
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 16px;
            outline: none;
        }
        input:focus { border-color: var(--accent); }

        .search-container {
            position: relative;
            margin-bottom: 25px;
        }
        .search-container input {
            padding-left: 48px;
            border: none;
            box-shadow: var(--shadow);
        }
        .search-icon {
            position: absolute;
            left: 18px; top: 14px;
            font-size: 18px;
            opacity: 0.5;
        }

        /* 
        ========================================================================
        6. –¢–ê–ë-–ë–ê–† (–ú–ï–ù–Æ)
        ========================================================================
        */
        .nav-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(var(--bg-card), 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            display: flex;
            padding: 12px 0 calc(12px + var(--safe-bottom));
            border-top: 0.5px solid var(--border);
            z-index: 2000;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-hint);
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 24px; }

        /* 
        ========================================================================
        7. –ú–ê–ì–ê–ó–ò–ù: –ö–ê–¢–ï–ì–û–†–ò–ò –ò –¢–û–í–ê–†–´
        ========================================================================
        */
        .categories-wrapper {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0 25px;
            margin: 0 -16px;
            padding-left: 16px;
            scrollbar-width: none;
        }
        .categories-wrapper::-webkit-scrollbar { display: none; }

        .chip {
            background: var(--bg-card);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 700;
            white-space: nowrap;
            border: 1.5px solid var(--border);
            color: var(--text-hint);
        }

        .chip.active {
            background: var(--text-main);
            color: var(--bg-page);
            border-color: var(--text-main);
        }

        .price-badge {
            font-size: 20px;
            font-weight: 900;
            color: var(--accent);
        }

        /* 
        ========================================================================
        8. –°–ò–°–¢–ï–ú–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´ (–õ–û–ê–î–ï–†, –¢–û–°–¢–´)
        ========================================================================
        */
        #loader {
            position: fixed; inset: 0;
            background: var(--bg-page);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 48px; height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        #toast {
            position: fixed;
            top: 30px; left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--text-main);
            color: var(--bg-page);
            padding: 12px 24px;
            border-radius: 40px;
            font-weight: 700;
            font-size: 14px;
            z-index: 10000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        #toast.visible { transform: translateX(-50%) translateY(0); }

        /* 
        ========================================================================
        9. –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨
        ========================================================================
        */
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            text-align: center;
        }
        .stat-val { font-size: 26px; font-weight: 900; color: var(--accent); }
        .stat-lbl { font-size: 11px; font-weight: 700; color: var(--text-hint); text-transform: uppercase; margin-top: 5px; }

        .badge {
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
        }
        .status-review { background: rgba(255, 149, 0, 0.1); color: var(--warning); }
        .status-done { background: rgba(52, 199, 89, 0.1); color: var(--success); }
        .status-reject { background: rgba(255, 59, 48, 0.1); color: var(--error); }

        .admin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .img-preview {
            width: 100%;
            border-radius: 12px;
            margin: 15px 0;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            cursor: pointer;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- –°–∏—Å—Ç–µ–º–Ω—ã–π –∑–∞–≥—Ä—É–∑—á–∏–∫ -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 20px; font-weight: 700; color: var(--text-hint);">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...</p>
        <button id="safety-btn" class="btn btn-sm btn-outline hidden" style="margin-top: 20px;" onclick="hideLoader()">–í–æ–π—Ç–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ</button>
    </div>

    <!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div id="toast">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>

    <div class="app-container">

        <!-- –°–¢–†–ê–ù–ò–¶–ê: –í–ò–¢–†–ò–ù–ê -->
        <section id="page-shop" class="page active">
            <h1>–ú–∞–≥–∞–∑–∏–Ω</h1>
            <p class="sub-header">–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä–æ–≤—ã–µ —É—Å–ª—É–≥–∏.</p>
            
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" id="shop-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." oninput="handleSearch()">
            </div>

            <div class="categories-wrapper" id="shop-categories">
                <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>

            <div id="shop-grid">
                <!-- –¢–æ–≤–∞—Ä—ã —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </section>

        <!-- –°–¢–†–ê–ù–ò–¶–ê: –û–ü–õ–ê–¢–ê -->
        <section id="page-checkout" class="page">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:25px;">
                <button class="btn btn-secondary btn-sm" onclick="switchPage('shop')">‚Üê</button>
                <h1 style="margin:0">–û–ø–ª–∞—Ç–∞</h1>
            </div>

            <div class="card">
                <span class="section-label" style="margin-top:0;">–†–µ–∫–≤–∏–∑–∏—Ç—ã</span>
                <div id="pay-reks" style="font-size:18px; font-weight:800; background:var(--bg-body); padding:20px; border-radius:16px; white-space:pre-wrap; margin:10px 0;"></div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                    <span style="font-weight:700;">–ö –æ–ø–ª–∞—Ç–µ:</span>
                    <span class="price-badge" id="pay-total">0 ‚ÇΩ</span>
                </div>
            </div>

            <div class="card">
                <span class="section-label" style="margin-top:0;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</span>
                <p style="font-size:14px; margin-bottom:15px; color:var(--text-hint);">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞. –ú—ã –ø—Ä–æ–≤–µ—Ä–∏–º –µ–≥–æ –≤—Ä—É—á–Ω—É—é.</p>
                <input type="file" id="pay-screenshot" accept="image/*">
                <button class="btn" style="margin-top:20px;" onclick="handleCheckout()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
            </div>
        </section>

        <!-- –°–¢–†–ê–ù–ò–¶–ê: –ó–ê–ö–ê–ó–´ -->
        <section id="page-orders" class="page">
            <h1>–ó–∞–∫–∞–∑—ã</h1>
            <p class="sub-header">–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫.</p>
            <div id="user-orders">
                <!-- –ó–∞–∫–∞–∑—ã —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </section>

        <!-- –°–¢–†–ê–ù–ò–¶–ê: –ü–†–û–§–ò–õ–¨ -->
        <section id="page-profile" class="page">
            <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
            <div class="card" style="text-align:center;">
                <div id="u-avatar" style="width:80px; height:80px; background:var(--accent); color:#fff; border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:900;">U</div>
                <div style="font-size:24px; font-weight:800;" id="u-name">User</div>
                <p class="sub-header" id="u-id" style="margin-top:5px;">ID: 000000</p>
            </div>
            <button class="btn btn-outline" onclick="openSupport()">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</button>
        </section>

        <!-- –°–¢–†–ê–ù–ò–¶–ê: –ê–î–ú–ò–ù-–í–•–û–î -->
        <section id="page-admin-auth" class="page">
            <h1>–ê–¥–º–∏–Ω-–¥–æ—Å—Ç—É–ø</h1>
            <div class="card">
                <label class="section-label">–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
                <input type="password" id="admin-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <button class="btn" style="margin-top:20px;" onclick="loginAdmin()">–í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å</button>
            </div>
        </section>

        <!-- –°–¢–†–ê–ù–ò–¶–ê: –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ -->
        <section id="page-admin-panel" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h1>
                <button class="btn btn-secondary btn-sm" onclick="logoutAdmin()">–í—ã—Ö–æ–¥</button>
            </div>

            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-val" id="stat-rev">0 ‚ÇΩ</div>
                    <div class="stat-lbl">–í—ã—Ä—É—á–∫–∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="stat-orders">0</div>
                    <div class="stat-lbl">–ó–∞–∫–∞–∑—ã</div>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-top:0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
                
                <label class="section-label">–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã</label>
                <textarea id="set-reks" rows="3" placeholder="–ö–∞—Ä—Ç–∞ –°–±–µ—Ä, –°–ë–ü, USDT..."></textarea>

                <label class="section-label">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ (–Æ–∑–µ—Ä–Ω–µ–π–º –±–µ–∑ @)</label>
                <input type="text" id="set-supp" placeholder="durov">

                <label class="section-label">ImgBB API –ö–ª—é—á</label>
                <input type="text" id="set-imgbb" placeholder="api.imgbb.com">

                <label class="section-label">Telegram Bot Token</label>
                <input type="text" id="set-token" placeholder="bot_token">

                <label class="section-label">–í–∞—à Chat ID</label>
                <input type="text" id="set-chat" placeholder="user_id">

                <label class="section-label">Lolz Market Token</label>
                <input type="text" id="set-lolz" placeholder="lzt.market token">

                <label class="section-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞</label>
                <input type="text" id="set-pass" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è">

                <button class="btn btn-sm" style="margin-top:20px;" onclick="saveConfig()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
            </div>

            <div class="card">
                <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="new-cat-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ...">
                    <button class="btn btn-sm" onclick="addCategory()">+</button>
                </div>
                <div id="admin-categories"></div>
            </div>

            <div class="card">
                <h2>–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</h2>
                <label class="section-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" id="p-name">
                <label class="section-label">–¶–µ–Ω–∞ (‚ÇΩ)</label>
                <input type="number" id="p-price">
                <label class="section-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="p-cat"></select>
                <label class="section-label">–¢–∏–ø –≤—ã–¥–∞—á–∏</label>
                <select id="p-type" onchange="togglePFields()">
                    <option value="text">–¢–µ–∫—Å—Ç (–ö–ª—é—á–∏/–ê–∫–∫–∞—É–Ω—Ç—ã)</option>
                    <option value="file">–§–∞–π–ª (–°—Å—ã–ª–∫–∞)</option>
                    <option value="lolz">Lolz Market (API)</option>
                </select>
                <div id="box-text">
                    <label class="section-label">–î–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞</label>
                    <textarea id="p-data" rows="3"></textarea>
                </div>
                <div id="box-lolz" class="hidden">
                    <label class="section-label">Lolz Search URL</label>
                    <input type="text" id="p-lolz-url" placeholder="https://lzt.market/telegram/...">
                </div>
                <button class="btn" style="margin-top:20px;" onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω</button>
            </div>

            <h2>–ó–∞–∫–∞–∑—ã –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h2>
            <div id="admin-orders-review"></div>

            <h2>–í—Å–µ —Ç–æ–≤–∞—Ä—ã</h2>
            <div id="admin-products-list"></div>
        </section>

    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchPage('shop')">
            <span class="nav-icon">üõçÔ∏è</span>
            <span>–ú–∞–≥–∞–∑–∏–Ω</span>
        </div>
        <div class="nav-item" onclick="switchPage('orders')">
            <span class="nav-icon">üì¶</span>
            <span>–ó–∞–∫–∞–∑—ã</span>
        </div>
        <div class="nav-item" onclick="switchPage('profile')">
            <span class="nav-icon">üë§</span>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
        <div class="nav-item" id="nav-adm" onclick="switchPage('admin')">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>–ê–¥–º–∏–Ω</span>
        </div>
    </nav>

    <script>
        /* 
        ========================================================================
        10. FIREBASE –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        ========================================================================
        */
        
        // –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ –∫–ª—é—á–∏ Firebase –∑–¥–µ—Å—å
        const firebaseConfig = {
            apiKey: "–í–ê–®_API_KEY",
            databaseURL: "https://–í–ê–®_PROJECT_ID.firebaseio.com",
            projectId: "–í–ê–®_PROJECT_ID",
        };

        // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        const loaderTimeout = setTimeout(() => {
            document.getElementById('safety-btn').classList.remove('hidden');
            document.querySelector('#loader p').innerText = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.";
        }, 5000);

        try {
            firebase.initializeApp(firebaseConfig);
            var rdb = firebase.database();
        } catch (e) {
            console.error("Firebase Init Error", e);
        }

        /* 
        ========================================================================
        11. –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
        ========================================================================
        */
        let state = {
            products: {},
            categories: {},
            orders: {},
            settings: {},
            activeCat: 'all',
            search: ''
        };

        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe?.user || { id: 777777, first_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' };
        let activePId = null;

        /* 
        ========================================================================
        12. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        ========================================================================
        */
        document.addEventListener('DOMContentLoaded', () => {
            tg.expand();
            document.getElementById('u-name').innerText = user.first_name;
            document.getElementById('u-id').innerText = `ID: ${user.id}`;
            document.getElementById('u-avatar').innerText = user.first_name[0].toUpperCase();

            // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Firebase
            rdb.ref('/').on('value', snapshot => {
                clearTimeout(loaderTimeout);
                const data = snapshot.val() || {};
                state.products = data.products || {};
                state.categories = data.categories || {};
                state.orders = data.orders || {};
                state.settings = data.settings || {};

                renderAll();
                hideLoader();
            }, (error) => {
                console.error("Firebase Data Error", error);
            });
        });

        /* 
        ========================================================================
        13. –†–û–£–¢–ò–ù–ì –ò –ò–ù–¢–ï–†–§–ï–ô–°
        ========================================================================
        */
        function switchPage(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));

            let tid = `page-${p}`;
            if(p === 'admin') tid = sessionStorage.getItem('isAdmin') ? 'page-admin-panel' : 'page-admin-auth';
            
            document.getElementById(tid).classList.add('active');
            const map = { 'shop': 0, 'orders': 1, 'profile': 2, 'admin': 3 };
            document.querySelectorAll('.nav-item')[map[p]].classList.add('active');
            window.scrollTo(0,0);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 3000);
        }

        function hideLoader() {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
        }

        /* 
        ========================================================================
        14. –õ–û–ì–ò–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê
        ========================================================================
        */
        function handleSearch() {
            state.search = document.getElementById('shop-search').value.toLowerCase();
            renderProducts();
        }

        function setCat(id) {
            state.activeCat = id;
            renderCats();
            renderProducts();
        }

        function renderAll() {
            renderCats();
            renderProducts();
            renderUserOrders();
            if(sessionStorage.getItem('isAdmin')) renderAdmin();
        }

        function renderCats() {
            const cont = document.getElementById('shop-categories');
            let html = `<div class="chip ${state.activeCat === 'all' ? 'active' : ''}" onclick="setCat('all')">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</div>`;
            Object.keys(state.categories).forEach(id => {
                const c = state.categories[id];
                html += `<div class="chip ${state.activeCat === id ? 'active' : ''}" onclick="setCat('${id}')">${c.name}</div>`;
            });
            cont.innerHTML = html;
        }

        function renderProducts() {
            const cont = document.getElementById('shop-grid');
            cont.innerHTML = '';
            const ids = Object.keys(state.products).filter(id => {
                const p = state.products[id];
                const mC = state.activeCat === 'all' || p.catId === state.activeCat;
                const mS = p.name.toLowerCase().includes(state.search);
                return mC && mS;
            });

            if(!ids.length) {
                cont.innerHTML = '<p style="text-align:center; padding:50px 0; color:var(--text-hint);">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                return;
            }

            ids.forEach(id => {
                const p = state.products[id];
                cont.innerHTML += `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <div style="font-size:20px; font-weight:800;">${p.name}</div>
                                <div style="font-size:12px; color:var(--text-hint); margin-top:5px;">${p.type === 'lolz' ? '–ê–≤—Ç–æ–≤—ã–¥–∞—á–∞ (Market)' : '–í—ã–¥–∞—á–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏'}</div>
                            </div>
                            <div class="price-badge">${p.price} ‚ÇΩ</div>
                        </div>
                        <button class="btn btn-sm" style="width:100%; margin-top:20px;" onclick="openCheckout('${id}')">–ó–∞–∫–∞–∑–∞—Ç—å</button>
                    </div>
                `;
            });
        }

        /* 
        ========================================================================
        15. –û–ü–õ–ê–¢–ê –ò –ß–ï–ö–ê–£–¢
        ========================================================================
        */
        function openCheckout(id) {
            activePId = id;
            document.getElementById('pay-reks').innerText = state.settings.reks || '–†–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.';
            document.getElementById('pay-total').innerText = `${state.products[id].price} ‚ÇΩ`;
            switchPage('shop');
            document.getElementById('page-shop').classList.remove('active');
            document.getElementById('page-checkout').classList.add('active');
        }

        async function handleCheckout() {
            const file = document.getElementById('pay-screenshot').files[0];
            const apiKey = state.settings.imgbb;
            if(!file || !apiKey) return showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API –Ω–∞—Å—Ç—Ä–æ–µ–Ω');

            setLoader(true, '–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...');
            try {
                const fd = new FormData();
                fd.append('image', file);
                const r = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: 'POST', body: fd });
                const res = await r.json();
                if(!res.success) throw new Error('–û—à–∏–±–∫–∞ ImgBB');

                const p = state.products[activePId];
                const oid = 'ORD' + Date.now();
                const orderData = {
                    id: oid, uId: user.id, uName: user.first_name + (user.username ? ` (@${user.username})` : ''),
                    pId: activePId, pName: p.name, price: Number(p.price), img: res.data.url,
                    status: 'review', date: new Date().toLocaleString()
                };

                await rdb.ref('orders/' + oid).set(orderData);
                await notifyAdmin(orderData);
                
                showToast('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!');
                document.getElementById('pay-screenshot').value = '';
                switchPage('orders');
            } catch(e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            } finally {
                setLoader(false);
            }
        }

        async function notifyAdmin(o) {
            const tok = state.settings.token;
            const cid = state.settings.chat;
            if(!tok || !cid) return;
            const txt = `üõç <b>–ù–û–í–´–ô –ó–ê–ö–ê–ó!</b>\n\nüë§ –ö–ª–∏–µ–Ω—Ç: ${o.uName}\nüì¶ –¢–æ–≤–∞—Ä: ${o.pName}\nüí∞ –°—É–º–º–∞: ${o.price} ‚ÇΩ\nüñº <a href="${o.img}">–ß–µ–∫ –æ–ø–ª–∞—Ç—ã</a>`;
            await fetch(`https://api.telegram.org/bot${tok}/sendMessage?chat_id=${cid}&text=${encodeURIComponent(txt)}&parse_mode=HTML`);
        }

        /* 
        ========================================
        16. –ò–°–¢–û–†–ò–Ø –ó–ê–ö–ê–ó–û–í
        ========================================
        */
        function renderUserOrders() {
            const cont = document.getElementById('user-orders');
            const my = Object.values(state.orders).filter(o => o.uId == user.id).reverse();
            
            if(!my.length) {
                cont.innerHTML = '<div style="text-align:center; padding:60px 0; color:var(--text-hint);">–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
                return;
            }

            cont.innerHTML = my.map(o => `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                        <div>
                            <div style="font-weight:800; font-size:18px;">${o.pName}</div>
                            <div style="font-size:11px; color:var(--text-hint);">${o.date}</div>
                        </div>
                        <span class="badge status-${o.status}">${o.status === 'review' ? '–ü—Ä–æ–≤–µ—Ä–∫–∞' : (o.status === 'done' ? '–í—ã–¥–∞–Ω' : '–û—Ç–∫–∞–∑')}</span>
                    </div>
                    <div class="price-badge" style="font-size:18px; margin-bottom:12px;">${o.price} ‚ÇΩ</div>
                    ${o.status === 'done' ? `
                        <div style="background:var(--bg-body); padding:15px; border-radius:12px; font-family:monospace; margin-top:10px; font-size:13px; border:1px dashed var(--success); word-break:break-all;"><b>–î–ê–ù–ù–´–ï:</b><br>${o.data}</div>
                    ` : ''}
                </div>
            `).join('');
        }

        function openSupport() {
            const s = state.settings.supp;
            if(s) tg.openTelegramLink(`https://t.me/${s}`);
            else showToast('–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞');
        }

        /* 
        ========================================
        17. –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ (–£–ü–†–ê–í–õ–ï–ù–ò–ï)
        ========================================
        */
        function loginAdmin() {
            const p = document.getElementById('admin-pass').value;
            if(p === (state.settings.adminPass || 'admin')) {
                sessionStorage.setItem('isAdmin', 'true');
                switchPage('admin');
            } else showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        }

        function logoutAdmin() {
            sessionStorage.clear();
            location.reload();
        }

        function togglePFields() {
            const t = document.getElementById('p-type').value;
            document.getElementById('box-text').className = t === 'lolz' ? 'hidden' : '';
            document.getElementById('box-lolz').className = t === 'lolz' ? '' : 'hidden';
        }

        function saveConfig() {
            const pass = document.getElementById('set-pass').value;
            const s = {
                reks: document.getElementById('set-reks').value,
                supp: document.getElementById('set-supp').value,
                imgbb: document.getElementById('set-imgbb').value,
                token: document.getElementById('set-token').value,
                chat: document.getElementById('set-chat').value,
                lolz: document.getElementById('set-lolz').value,
                adminPass: pass || state.settings.adminPass || 'admin'
            };
            rdb.ref('settings').set(s).then(() => showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!'));
        }

        function addCategory() {
            const n = document.getElementById('new-cat-name').value;
            if(n) rdb.ref('categories').push({ name: n }).then(() => {
                document.getElementById('new-cat-name').value = '';
                showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞');
            });
        }

        function addProduct() {
            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            const catId = document.getElementById('p-cat').value;
            const type = document.getElementById('p-type').value;
            if(!name || !price || !catId) return showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');

            const p = {
                name, price: Number(price), catId, type,
                data: type === 'lolz' ? '' : document.getElementById('p-data').value,
                lolzUrl: type === 'lolz' ? document.getElementById('p-lolz-url').value : ''
            };
            rdb.ref('products').push(p).then(() => {
                showToast('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
                document.getElementById('p-name').value = '';
                document.getElementById('p-price').value = '';
                document.getElementById('p-data').value = '';
            });
        }

        function renderAdmin() {
            const s = state.settings;
            document.getElementById('set-reks').value = s.reks || '';
            document.getElementById('set-supp').value = s.supp || '';
            document.getElementById('set-imgbb').value = s.imgbb || '';
            document.getElementById('set-token').value = s.token || '';
            document.getElementById('set-chat').value = s.chat || '';
            document.getElementById('set-lolz').value = s.lolz || '';

            const done = Object.values(state.orders).filter(o => o.status === 'done');
            document.getElementById('stat-rev').innerText = `${done.reduce((a,b) => a+b.price, 0)} ‚ÇΩ`;
            document.getElementById('stat-orders').innerText = done.length;

            // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            const cSel = document.getElementById('p-cat');
            const cList = document.getElementById('admin-categories');
            cSel.innerHTML = ''; cList.innerHTML = '';
            Object.keys(state.categories).forEach(id => {
                cSel.innerHTML += `<option value="${id}">${state.categories[id].name}</option>`;
                cList.innerHTML += `<div class="admin-item"><span>${state.categories[id].name}</span><b style="color:red" onclick="rdb.ref('categories/${id}').remove()">–£–¥–∞–ª–∏—Ç—å</b></div>`;
            });

            // –ó–∞–∫–∞–∑—ã
            const rev = document.getElementById('admin-orders-review');
            const waiting = Object.values(state.orders).filter(o => o.status === 'review');
            rev.innerHTML = waiting.map(o => `
                <div class="card" style="border-left:5px solid var(--warning);">
                    <b>${o.pName} (${o.price}‚ÇΩ)</b><br><small>${o.uName}</small>
                    <img src="${o.img}" class="img-preview" onclick="window.open('${o.img}')">
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-sm" onclick="approveOrder('${o.id}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                        <button class="btn btn-sm btn-outline btn-danger" onclick="updateStatus('${o.id}', 'reject')">–û—Ç–∫–∞–∑</button>
                    </div>
                </div>
            `).join('') || '<p style="font-size:13px; color:var(--text-hint);">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>';

            // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
            const pList = document.getElementById('admin-products-list');
            pList.innerHTML = Object.keys(state.products).map(id => `
                <div class="admin-item">
                    <span>${state.products[id].name}</span>
                    <button class="btn btn-sm btn-danger" onclick="rdb.ref('products/${id}').remove()">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        }

        /* 
        ========================================
        18. –í–´–î–ê–ß–ê –ò LOLZ API
        ========================================
        */
        async function approveOrder(oid) {
            const o = state.orders[oid];
            const p = state.products[o.pId];
            setLoader(true, '–í—ã–¥–∞—á–∞ —Ç–æ–≤–∞—Ä–∞...');

            try {
                let d = "";
                if(p.type === 'lolz') {
                    d = await fetchLolz(p.lolzUrl);
                } else {
                    d = p.data || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
                }
                await rdb.ref('orders/' + oid).update({ status: 'done', data: d });
                showToast('–ó–∞–∫–∞–∑ –æ–¥–æ–±—Ä–µ–Ω!');
            } catch(e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            } finally {
                setLoader(false);
            }
        }

        async function fetchLolz(url) {
            const tok = state.settings.lolz;
            if(!tok) throw new Error('Lolz Token –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
            
            // –ü—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
            const target = `https://api.lzt.market/list?${url.split('?')[1] || ''}`;
            const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(target)}`;
            
            try {
                const r = await fetch(proxy, { headers: { 'Authorization': `Bearer ${tok}` } });
                const d = await r.json();
                if(!d.items || !d.items.length) throw new Error('–ê–∫–∫–∞—É–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                
                const i = d.items[0];
                return `ID: ${i.item_id}\n–ù–∞–∑–≤–∞–Ω–∏–µ: ${i.item_title}\n–¶–µ–Ω–∞: ${i.price}${i.currency}\n–î–∞–Ω–Ω—ã–µ –Ω–∞ lzt.market –≤ —Ä–∞–∑–¥–µ–ª–µ –ø–æ–∫—É–ø–æ–∫.`;
            } catch(e) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å API Lolz. –í—ã–¥–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
            }
        }

        function updateStatus(oid, s) {
            if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) rdb.ref('orders/' + oid + '/status').set(s);
        }

        function setLoader(s, t = '') {
            const l = document.getElementById('loader');
            if(s) {
                l.style.display = 'flex';
                l.style.opacity = '1';
                document.querySelector('#loader p').innerText = t;
            } else {
                hideLoader();
            }
        }
    </script>
</body>
</html>
