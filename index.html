<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Digital Store</title>
    
    <!-- SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #1a1a1a;
            --accent: #000000;
            --hint: #909090;
            --border: #eaeaea;
            --success: #27ae60;
            --wait: #f39c12;
            --danger: #eb5757;
            --radius: 20px;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            line-height: 1.5;
        }

        .container {
            padding: 20px 16px 100px 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Typography */
        h1 { font-size: 28px; font-weight: 800; margin-bottom: 20px; letter-spacing: -0.5px; }
        h2 { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--hint); margin: 30px 0 15px; }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        /* Buttons */
        .btn {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 16px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:active { transform: scale(0.97); opacity: 0.9; }
        .btn-secondary { background: #eee; color: #000; }
        .btn-sm { padding: 10px 15px; font-size: 13px; width: auto; border-radius: 10px; }
        .btn-danger { color: var(--danger); border: 1px solid var(--danger); background: transparent; }

        /* Status Badges */
        .badge {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-wait { background: #fff4e5; color: #f39c12; }
        .status-review { background: #eef2ff; color: #4f46e5; }
        .status-done { background: #eefdf5; color: #27ae60; }

        /* Inputs */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 6px; color: var(--hint); }
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #fff;
            font-size: 15px;
            color: var(--text);
        }

        /* Nav */
        .nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px);
            display: flex; justify-content: space-around;
            padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
            border-top: 1px solid var(--border);
            z-index: 1000;
        }
        .nav-item {
            background: none; border: none; color: var(--hint);
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 22px; }

        /* Custom */
        .price { font-size: 20px; font-weight: 800; color: var(--accent); }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        
        <!-- –ú–ê–ì–ê–ó–ò–ù -->
        <div id="page-shop" class="page active">
            <h1>–ú–∞–≥–∞–∑–∏–Ω</h1>
            <div id="shop-content">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
        </div>

        <!-- –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê (–û–ü–õ–ê–¢–ê) -->
        <div id="page-checkout" class="page">
            <button class="btn btn-secondary btn-sm" onclick="switchPage('shop')">‚Üê –ù–∞–∑–∞–¥</button>
            <h1>–û–ø–ª–∞—Ç–∞</h1>
            <div class="card">
                <p>–î–ª—è –æ–ø–ª–∞—Ç—ã –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º:</p>
                <div id="pay-details-text" style="font-weight: 700; margin: 15px 0; padding: 15px; background: #f0f0f0; border-radius: 10px; white-space: pre-wrap;"></div>
                <div class="price" id="pay-amount">0 ‚ÇΩ</div>
            </div>
            
            <div class="card">
                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–ø–ª–∞—Ç—ã</label>
                <textarea id="pay-screenshot" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç (imgbb/telegra.ph)"></textarea>
                <button class="btn" style="margin-top:10px" onclick="submitOrder()">–Ø –æ–ø–ª–∞—Ç–∏–ª</button>
            </div>
        </div>

        <!-- –ü–†–û–§–ò–õ–¨ -->
        <div id="page-profile" class="page">
            <h1>–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</h1>
            <div id="order-history"></div>
        </div>

        <!-- –í–•–û–î –í –ê–î–ú–ò–ù–ö–£ -->
        <div id="page-admin-login" class="page">
            <h1>–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∞</h1>
            <div class="form-group">
                <input type="password" id="admin-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            </div>
            <button class="btn" onclick="tryAdminAuth()">–í–æ–π—Ç–∏</button>
        </div>

        <!-- –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ -->
        <div id="page-admin-panel" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h1>–ü–∞–Ω–µ–ª—å</h1>
                <button class="btn btn-sm btn-secondary" onclick="adminLogout()">–í—ã—Ö–æ–¥</button>
            </div>

            <div class="card">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–ª–∞—Ç—ã</h2>
                <textarea id="cfg-payment" placeholder="–†–µ–∫–≤–∏–∑–∏—Ç—ã (–ö–∞—Ä—Ç–∞, –°–ë–ü, –ö—Ä–∏–ø—Ç–∞)"></textarea>
                <button class="btn btn-sm" style="margin-top:10px" onclick="saveAdminSetting('payment', 'cfg-payment')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <div class="card">
                <h2>Lolz Token</h2>
                <input type="text" id="cfg-lolz" placeholder="API Token Market">
                <button class="btn btn-sm" style="margin-top:10px" onclick="saveAdminSetting('lolz', 'cfg-lolz')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <div class="card">
                <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
                <div class="form-group">
                    <input type="text" id="p-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                </div>
                <div class="form-group">
                    <input type="number" id="p-price" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)">
                </div>
                <div class="form-group">
                    <label>–¢–∏–ø —Ç–æ–≤–∞—Ä–∞</label>
                    <select id="p-type" onchange="toggleTypeFields()">
                        <option value="text">–¢–µ–∫—Å—Ç (–ö–ª—é—á/–ê–∫–∫–∞—É–Ω—Ç)</option>
                        <option value="file">–§–∞–π–ª (–°—Å—ã–ª–∫–∞)</option>
                        <option value="lolz">Lolzteam (–ê–≤—Ç–æ–≤—ã–∫—É–ø)</option>
                    </select>
                </div>
                <div class="form-group" id="f-value">
                    <label id="l-value">–î–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞</label>
                    <textarea id="p-value" placeholder="–°–∞–º —Ç–µ–∫—Å—Ç —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª"></textarea>
                </div>
                <div class="form-group hidden" id="f-lolz">
                    <label>–°—Å—ã–ª–∫–∞ –ø–æ–∏—Å–∫–∞ Lolz</label>
                    <input type="text" id="p-lolz-url" placeholder="https://lzt.market/...">
                </div>
                <button class="btn" onclick="db_addProduct()">–î–æ–±–∞–≤–∏—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω</button>
            </div>

            <h2>–ó–∞–∫–∞–∑—ã –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</h2>
            <div id="admin-orders-check"></div>

            <h2>–í—Å–µ —Ç–æ–≤–∞—Ä—ã</h2>
            <div id="admin-products-list"></div>
        </div>

    </div>

    <!-- –¢–ê–ë–´ -->
    <nav class="nav">
        <button class="nav-item active" onclick="switchPage('shop')">
            <span class="nav-icon">üõçÔ∏è</span><span>–ú–∞–≥–∞–∑–∏–Ω</span>
        </button>
        <button class="nav-item" onclick="switchPage('profile')">
            <span class="nav-icon">üì¶</span><span>–ó–∞–∫–∞–∑—ã</span>
        </button>
        <button id="nav-admin" class="nav-item" onclick="switchPage('admin')">
            <span class="nav-icon">‚öôÔ∏è</span><span>–ê–¥–º–∏–Ω</span>
        </button>
    </nav>

    <script>
        // --- –ö–û–ù–§–ò–ì FIREBASE (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò) ---
        const firebaseConfig = {
            apiKey: "AIzaSyApyvMlfHcFqPt1ROpnqCPXjgkuUjV1hus",
            databaseURL: "https://zikrov09-default-rtdb.firebaseio.com",
            projectId: "zikrov09",
        };
        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();

        let state = { products: {}, settings: {}, orders: {} };
        let activeProduct = null;
        const tg = window.Telegram.WebApp;

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        document.addEventListener('DOMContentLoaded', () => {
            tg.expand();
            rdb.ref('/').on('value', snapshot => {
                state = snapshot.val() || { products: {}, settings: {}, orders: {} };
                renderShop();
                renderAdmin();
                renderProfile();
            });
            checkAdminVisibility();
        });

        function switchPage(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            let target = 'page-' + p;
            if (p === 'admin') {
                target = sessionStorage.getItem('is_admin') ? 'page-admin-panel' : 'page-admin-login';
            }
            
            document.getElementById(target).classList.add('active');
            const navs = document.querySelectorAll('.nav-item');
            if(p === 'shop') navs[0].classList.add('active');
            if(p === 'profile') navs[1].classList.add('active');
            if(p === 'admin') navs[2].classList.add('active');
        }

        // --- –ú–ê–ì–ê–ó–ò–ù ---
        function renderShop() {
            const cont = document.getElementById('shop-content');
            cont.innerHTML = '';
            const prods = state.products || {};
            if(Object.keys(prods).length === 0) cont.innerHTML = '<div class="card">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
            
            Object.keys(prods).forEach(id => {
                const p = prods[id];
                cont.innerHTML += `
                    <div class="card">
                        <div style="font-size:18px; font-weight:800">${p.name}</div>
                        <div style="color:var(--hint); font-size:12px; margin:5px 0">–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –≤—ã–¥–∞—á–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px">
                            <div class="price">${p.price} ‚ÇΩ</div>
                            <button class="btn btn-sm" onclick="startCheckout('${id}')">–ö—É–ø–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            });
        }

        function startCheckout(id) {
            activeProduct = id;
            const p = state.products[id];
            document.getElementById('pay-details-text').innerText = state.settings.payment || '–†–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã';
            document.getElementById('pay-amount').innerText = p.price + ' ‚ÇΩ';
            switchPage('checkout');
        }

        function submitOrder() {
            const proof = document.getElementById('pay-screenshot').value;
            if(!proof) return alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ–± –æ–ø–ª–∞—Ç–µ');
            
            const p = state.products[activeProduct];
            const orderId = 'ORD' + Date.now();
            const userId = tg.initDataUnsafe.user?.id || 'guest';
            
            rdb.ref('orders/' + orderId).set({
                id: orderId,
                userId: userId,
                userName: tg.initDataUnsafe.user?.first_name || 'Guest',
                productName: p.name,
                productId: activeProduct,
                price: p.price,
                proof: proof,
                status: 'review',
                date: new Date().toLocaleString()
            });
            
            alert('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!');
            document.getElementById('pay-screenshot').value = '';
            switchPage('profile');
        }

        // --- –ü–†–û–§–ò–õ–¨ ---
        function renderProfile() {
            const cont = document.getElementById('order-history');
            const userId = tg.initDataUnsafe.user?.id || 'guest';
            const orders = state.orders || {};
            const my = Object.values(orders).filter(o => o.userId == userId);
            
            if(my.length === 0) {
                cont.innerHTML = '<div class="card">–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
                return;
            }

            cont.innerHTML = my.reverse().map(o => `
                <div class="card">
                    <div style="display:flex; justify-content:space-between">
                        <b>${o.productName}</b>
                        <span class="badge status-${o.status}">${o.status === 'review' ? '–ü—Ä–æ–≤–µ—Ä–∫–∞' : (o.status === 'done' ? '–í—ã–¥–∞–Ω' : '–û—Ç–∫–ª–æ–Ω–µ–Ω')}</span>
                    </div>
                    <div style="font-size:12px; margin-top:5px; color:var(--hint)">${o.date} ‚Ä¢ ${o.price} ‚ÇΩ</div>
                    ${o.status === 'done' ? `<div style="margin-top:10px; padding:10px; background:#f0fdf4; border-radius:10px; font-size:13px; font-family:monospace; border:1px dashed #27ae60">–î–∞–Ω–Ω—ã–µ: ${o.issuedData}</div>` : ''}
                </div>
            `).join('');
        }

        // --- –ê–î–ú–ò–ù–ö–ê ---
        function tryAdminAuth() {
            if(document.getElementById('admin-pass').value === 'admin123') {
                sessionStorage.setItem('is_admin', 'true');
                checkAdminVisibility();
                switchPage('admin');
            } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        }

        function adminLogout() {
            sessionStorage.removeItem('is_admin');
            checkAdminVisibility();
            switchPage('shop');
        }

        function checkAdminVisibility() {
            // –í–∫–ª–∞–¥–∫–∞ –∞–¥–º–∏–Ω–∞ –≤–∏–¥–Ω–∞ –≤—Å–µ–º, –Ω–æ –≤—Ö–æ–¥ –∑–∞—â–∏—â–µ–Ω. –î–ª—è –ø–æ–ª–Ω–æ–π —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å hidden.
        }

        function toggleTypeFields() {
            const type = document.getElementById('p-type').value;
            document.getElementById('f-value').classList.toggle('hidden', type === 'lolz');
            document.getElementById('f-lolz').classList.toggle('hidden', type !== 'lolz');
        }

        function db_addProduct() {
            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            const type = document.getElementById('p-type').value;
            const value = document.getElementById('p-value').value;
            const lolzUrl = document.getElementById('p-lolz-url').value;

            if(!name || !price) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
            
            rdb.ref('products').push({
                name, price, type, value, lolzUrl
            });
            alert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
        }

        function renderAdmin() {
            if(!sessionStorage.getItem('is_admin')) return;

            document.getElementById('cfg-payment').value = state.settings.payment || '';
            document.getElementById('cfg-lolz').value = state.settings.lolz || '';

            // –ó–∞–∫–∞–∑—ã –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
            const checkCont = document.getElementById('admin-orders-check');
            const toReview = Object.values(state.orders || {}).filter(o => o.status === 'review');
            checkCont.innerHTML = toReview.map(o => `
                <div class="card">
                    <b>${o.productName}</b> (${o.price} ‚ÇΩ)<br>
                    –Æ–∑–µ—Ä: ${o.userName}<br>
                    <small>–ü—Ä—É—Ñ: ${o.proof}</small>
                    <div style="display:flex; gap:10px; margin-top:10px">
                        <button class="btn btn-sm" onclick="approveOrder('${o.id}')">–û–¥–æ–±—Ä–∏—Ç—å</button>
                        <button class="btn btn-sm btn-danger" onclick="rdb.ref('orders/${o.id}/status').set('rejected')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');

            // –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
            const pList = document.getElementById('admin-products-list');
            pList.innerHTML = Object.keys(state.products || {}).map(id => `
                <div class="item-row">
                    <span>${state.products[id].name}</span>
                    <button class="btn btn-sm btn-danger" onclick="rdb.ref('products/${id}').remove()">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        }

        async function approveOrder(orderId) {
            const order = state.orders[orderId];
            const product = state.products[order.productId];
            let issuedData = "–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏";

            if (product.type === 'lolz') {
                issuedData = await buyFromLolz(product.lolzUrl);
            } else {
                issuedData = product.value;
            }

            rdb.ref('orders/' + orderId).update({
                status: 'done',
                issuedData: issuedData
            });
            alert('–ó–∞–∫–∞–∑ –æ–¥–æ–±—Ä–µ–Ω –∏ –≤—ã–¥–∞–Ω!');
        }

        async function buyFromLolz(searchUrl) {
            const token = state.settings.lolz;
            if(!token) return "–û—à–∏–±–∫–∞: Lolz Token –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω";
            
            try {
                const proxy = "https://api.allorigins.win/raw?url=";
                const searchApi = encodeURIComponent(`https://api.lzt.market/list?${searchUrl.split('?')[1] || ''}`);
                const res = await fetch(proxy + searchApi, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                
                if(!data.items || data.items.length === 0) return "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏ –Ω–∞ Lolz";
                
                const item = data.items[0];
                // –†–µ–∑–µ—Ä–≤ –∏ –ü–æ–∫—É–ø–∫–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞, –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å POST –∑–∞–ø—Ä–æ—Å—ã)
                return `ID: ${item.item_id} | –î–∞–Ω–Ω—ã–µ: ${item.login_password || '–í –∞—Ä—Ö–∏–≤–µ –º–∞—Ä–∫–µ—Ç–∞'}`;
            } catch(e) { return "–û—à–∏–±–∫–∞ API Lolz"; }
        }

        function saveAdminSetting(key, inputId) {
            const val = document.getElementById(inputId).value;
            rdb.ref('settings/' + key).set(val);
            alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        }
    </script>
</body>
</html>
